const t={ID:"token-action-hud-l5r5e"},e={ID:"token-action-hud-core"},i="2.0.12",n={item:"tokenActionHud.template.item",utility:"tokenActionHud.utility",armor:"l5r5e.armors.title",equipped:"tokenActionHud.equipped",unequipped:"tokenActionHud.unequipped",equipment:"l5r5e.items.title",weapons:"l5r5e.weapons.title",technique:"l5r5e.techniques.title",ring:"l5r5e.rings.title",skill:"l5r5e.skills.title",derived:"l5r5e.attributes.title",standing:"l5r5e.social.title"},s={armor:{id:"armor",name:"l5r5e.armors.title",type:"system"},equipment:{id:"equipment",name:"l5r5e.items.title",type:"system"},equipped:{id:"equipped",name:"Equipped",type:"system"},unequipped:{id:"unequipped",name:"Unequipped",type:"system"},weapons:{id:"weapons",name:"l5r5e.weapons.title",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},rests:{id:"rests",name:"tokenActionHud.rests",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},rings:{id:"rings",name:"l5r5e.rings.title",type:"system"},derived:{id:"derived",name:"l5r5e.attributes.title",type:"system"},standing:{id:"standing",name:"l5r5e.social.title",type:"system"},artisan:{id:"artisan",name:"l5r5e.skills.artisan.title",type:"system"},martial:{id:"martial",name:"l5r5e.skills.martial.title",type:"system"},scholar:{id:"scholar",name:"l5r5e.skills.scholar.title",type:"system"},social:{id:"social",name:"l5r5e.skills.social.title",type:"system"},trade:{id:"trade",name:"l5r5e.skills.trade.title",type:"system"},kata:{id:"kata",name:"l5r5e.techniques.kata",type:"system"},kiho:{id:"kiho",name:"l5r5e.techniques.kiho",type:"system"},inversion:{id:"inversion",name:"l5r5e.techniques.inversion",type:"system"},invocation:{id:"invocation",name:"l5r5e.techniques.invocation",type:"system"},ritual:{id:"ritual",name:"l5r5e.techniques.ritual",type:"system"},shuji:{id:"shuji",name:"l5r5e.techniques.shuji",type:"system"},maho:{id:"maho",name:"l5r5e.techniques.maho",type:"system"},ninjutsu:{id:"ninjutsu",name:"l5r5e.techniques.ninjutsu",type:"system"},mantra:{id:"mantra",name:"l5r5e.techniques.mantra",type:"system"},school_ability:{id:"school-ability",name:"l5r5e.techniques.school_ability",type:"system"},mastery_ability:{id:"mastery-ability",name:"l5r5e.techniques.mastery_ability",type:"system"},title_ability:{id:"title-ability",name:"l5r5e.techniques.title_ability",type:"system"}},r={armor:{groupId:"armor"},equipment:{groupId:"equipment"},item:{groupId:"equipment"},weapon:{groupId:"weapons"}},l={artisan:{groupId:"artisan"},martial:{groupId:"martial"},scholar:{groupId:"scholar"},social:{groupId:"social"},trade:{groupId:"trade"}},a={razor_edged:"tokenActionHud.l5r5e.qualities.razorEdged",ceremonial:"tokenActionHud.l5r5e.qualities.ceremonial",damaged:"tokenActionHud.l5r5e.qualities.damaged",destroyed:"tokenActionHud.l5r5e.qualities.destroyed",concealable:"tokenActionHud.l5r5e.qualities.concealable",cumbersome:"tokenActionHud.l5r5e.qualities.cumbersome",snaring:"tokenActionHud.l5r5e.qualities.snaring",unholy:"tokenActionHud.l5r5e.qualities.unholy",forbidden:"tokenActionHud.l5r5e.qualities.forbidden",resplendent:"tokenActionHud.l5r5e.qualities.resplendent",wargear:"tokenActionHud.l5r5e.qualities.wargear",mundane:"tokenActionHud.l5r5e.qualities.mundane",prepare:"tokenActionHud.l5r5e.qualities.prepare",sacred:"tokenActionHud.l5r5e.qualities.sacred",durable:"tokenActionHud.l5r5e.qualities.durable",subtle:"tokenActionHud.l5r5e.qualities.subtle",kenzo_blade:"tokenActionHud.l5r5e.qualities.kenzoBlade"},o={jade_inlay:"tokenActionHud.l5r5e.patterns.jadeInlay",uchema:"tokenActionHud.l5r5e.patterns.uchema",yasunori:"tokenActionHud.l5r5e.patterns.yasunori",akodo:"tokenActionHud.l5r5e.patterns.akodo",burning_water:"tokenActionHud.l5r5e.patterns.burningWater",concealment:"tokenActionHud.l5r5e.patterns.concealment",deadly_fangs:"tokenActionHud.l5r5e.patterns.deadlyFangs",fearsome_snarl:"tokenActionHud.l5r5e.patterns.fearsomeSnarl",ichiro:"tokenActionHud.l5r5e.patterns.ichiro",mountain_silk:"tokenActionHud.l5r5e.patterns.mountainSilk",screaming_fire:"tokenActionHud.l5r5e.patterns.screamingFire",toriyama:"tokenActionHud.l5r5e.patterns.toriyama",qamarist:"tokenActionHud.l5r5e.patterns.qamarist",yodhaniya:"tokenActionHud.l5r5e.patterns.yodhaniya",kokejin:"tokenActionHud.l5r5e.patterns.kokejin",agasha:"tokenActionHud.l5r5e.patterns.agasha"},c={default:{icon:"fa-solid fa-tag",class:"tah-tag-secondary"},pattern:{icon:"fa-solid fa-swatchbook",class:"tah-tag-tertiary"},bonus:{icon:"fa-solid fa-arrow-up-right-dots",class:"tah-tag-alt"},clan:{label:"tokenActionHud.l5r5e.tags.clan",icon:"fa-solid fa-flag",class:"tah-tag-secondary"},culture:{label:"tokenActionHud.l5r5e.tags.culture",icon:"fa-solid fa-earth-asia",class:"tah-tag-secondary"},material:{label:"tokenActionHud.l5r5e.tags.material",icon:"fa-solid fa-gem",class:"tah-tag-secondary"},tradition:{label:"tokenActionHud.l5r5e.tags.tradition",icon:"fa-solid fa-scroll",class:"tah-tag-secondary"}},u={armorTN:{label:"tokenActionHud.l5r5e.bonuses.armorTN",icon:"fa-solid fa-shield-halved",class:"tah-tag-alt"},resistance:{label:"tokenActionHud.l5r5e.bonuses.resistance",icon:"fa-solid fa-shield",class:"tah-tag-alt"},fatigue:{label:"tokenActionHud.l5r5e.bonuses.fatigue",icon:"fa-solid fa-heart-pulse",class:"tah-tag-alt"},strife:{label:"tokenActionHud.l5r5e.bonuses.strife",icon:"fa-solid fa-fire",class:"tah-tag-alt"},deadliness:{label:"tokenActionHud.l5r5e.bonuses.deadliness",icon:"fa-solid fa-skull",class:"tah-tag-alt"},damage:{label:"tokenActionHud.l5r5e.bonuses.damage",icon:"fa-solid fa-burst",class:"tah-tag-alt"},opportunities:{label:"tokenActionHud.l5r5e.bonuses.opportunities",icon:"fa-solid fa-dice-d20",class:"tah-tag-alt"}},d=[{id:"kata",actorKey:"kata",translationKey:"l5r5e.techniques.kata"},{id:"kiho",actorKey:"kiho",translationKey:"l5r5e.techniques.kiho"},{id:"inversion",actorKey:"inversion",translationKey:"l5r5e.techniques.inversion"},{id:"invocation",actorKey:"invocation",translationKey:"l5r5e.techniques.invocation"},{id:"ritual",actorKey:"ritual",translationKey:"l5r5e.techniques.ritual"},{id:"shuji",actorKey:"shuji",translationKey:"l5r5e.techniques.shuji"},{id:"maho",actorKey:"maho",translationKey:"l5r5e.techniques.maho"},{id:"ninjutsu",actorKey:"ninjutsu",translationKey:"l5r5e.techniques.ninjutsu"},{id:"mantra",actorKey:"mantra",translationKey:"l5r5e.techniques.mantra"},{id:"school-ability",actorKey:"school_ability",translationKey:"l5r5e.techniques.school_ability"},{id:"mastery-ability",actorKey:"mastery_ability",translationKey:"l5r5e.techniques.mastery_ability"},{id:"title-ability",actorKey:"title_ability",translationKey:"l5r5e.techniques.title_ability"}],p=[{id:"armor",actorKey:"armor",translationKey:"l5r5e.armors.title"},{id:"equipment",actorKey:"equipment",translationKey:"l5r5e.items.title"},{id:"weapons",actorKey:"weapons",translationKey:"l5r5e.weapons.title"}],f={derived:{helperMethods:["getDerivedAttributesList","getDerivedList","getDerivedAttributes"],helperArgsSets:t=>[[t],[]],configPaths:["derivedAttributes","derived","attributes.derived"],actorPaths:["derived","attributes.derived"],translationPrefix:"l5r5e.attributes"},standing:{helperMethods:["getStandingAttributesList","getStandingList","getSocialAttributesList","getSocialAttributes"],helperArgsSets:t=>[[t],[]],configPaths:["standingAttributes","standing","social","attributes.social"],actorPaths:["standing","social","attributes.standing","attributes.social"],translationPrefix:"l5r5e.social"}};function sanitizeId(t){if(null==t)return"";return String(t).trim().replace(/\s+/g,"-").replace(/_/g,"-").toLowerCase()}function unsanitizeId(t){if(null==t)return"";return String(t).trim().replace(/\s+/g,"_").replace(/-/g,"_")}function getTechniqueTypeEntries(){return dedupeEntries(collectEntries({helperMethods:["getTechniqueTypesList","getTechniqueTypes","getTechniquesTypesList","getTechniquesList"],configPaths:["techniqueTypes","technique_types","techniques.types","techniques.categories","techniques.type"],translationPrefix:"l5r5e.techniques",stringIsTranslation:!0,fallback:d}))}function getInventoryGroupEntries(){return dedupeEntries(collectEntries({helperMethods:["getInventoryGroupIds","getInventoryCategoriesList","getInventorySections"],configPaths:["inventory.groups","inventory.categories","inventoryCategories","itemGroups.inventory","items.inventory"],translationPrefix:null,stringIsTranslation:!0,fallback:p}))}function getAttributeEntries(t,e){const i=f[t];if(!i)return{entries:[],section:null};const n="function"==typeof i.helperArgsSets?i.helperArgsSets(e):i.helperArgsSets??[[]],s=collectEntries({helperMethods:i.helperMethods,helperArgsSets:n,configPaths:i.configPaths,translationPrefix:i.translationPrefix,stringIsTranslation:!0,fallback:[]}),r=getActorSection(e,i.actorPaths);if(s.length>0)return{entries:dedupeEntries(s),section:r};if(!r)return{entries:[],section:null};return{entries:dedupeEntries(Object.keys(r).map((t=>{const e=t;return{id:sanitizeId(e),actorKey:e,translationKey:i.translationPrefix?buildTranslationKey(i.translationPrefix,e):null}}))),section:r}}function getActorSection(t,e=[]){if(!t)return null;const i=t.system??{};for(const t of e){const e=getProperty(i,t);if(e)return e}return null}function collectEntries({helperMethods:t=[],helperArgsSets:e=[[]],configPaths:i=[],translationPrefix:n=null,stringIsTranslation:s=!1,fallback:r=[]}){const l=function getEntriesFromHelpers(t,e,i,n){const s=game?.l5r5e?.HelpersL5r5e;if(!s)return[];for(const r of t){const t=s?.[r];if("function"==typeof t)for(const l of e)try{const e=normalizeEntries(Array.isArray(l)?t.apply(s,l):t.call(s,l),{translationPrefix:i,stringIsTranslation:n});if(e.length>0)return e}catch(t){console.debug(`Token Action HUD L5R5e | Helper ${r} failed`,t)}}return[]}(t,e,n,s);if(l.length>0)return l;const a=function getEntriesFromConfig(t,e,i){const n=CONFIG?.l5r5e;if(!n)return[];for(const s of t){const t=normalizeEntries(getProperty(n,s),{translationPrefix:e,stringIsTranslation:i});if(t.length>0)return t}return[]}(i,n,s);return a.length>0?a:r}function normalizeEntries(t,e={}){if(!t)return[];if(t instanceof Map)return[...t.entries()].map((([t,i])=>normalizeEntry(i,t,e))).filter(Boolean);if(Array.isArray(t))return t.map(((t,i)=>normalizeEntry(t,t?.id??t?.key??t?.type??t?.slug??t??i,e))).filter(Boolean);if("object"==typeof t)return Object.entries(t).map((([t,i])=>normalizeEntry(i,t,e))).filter(Boolean);if("string"==typeof t){const i=normalizeEntry(t,t,e);return i?[i]:[]}return[]}function normalizeEntry(t,e,{translationPrefix:i,stringIsTranslation:n}={}){if(null==t)return null;let s,r,l,a;if("object"!=typeof t||Array.isArray(t)?"string"==typeof t?(s=e??t,n&&t.includes(".")?r=t:e||(s=t),!r&&!l&&n&&t.includes(".")&&(r=t),l||n||(l=t)):s=e:(s=t.id??t.key??t.type??t.slug??t.value??t.name??e,r=t.translationKey??t.labelKey??t.i18n??null,l=t.label??t.name??t.title??t.display??t.text??null,a=t.path??t.dataPath??null),!s&&0!==s)return null;const o="string"==typeof s?s:String(s),c=sanitizeId(o);return!r&&i&&(r=buildTranslationKey(i,o)),{id:c,actorKey:o,translationKey:r,label:l,path:a}}function buildTranslationKey(t,e){if(!t||null==e)return null;return`${t}.${String(e).replace(/\s+/g,"_").replace(/-/g,"_").toLowerCase()}`}function dedupeEntries(t){const e=new Map;for(const i of t)i?.id&&(e.has(i.id)||e.set(i.id,i));return[...e.values()]}function getProperty(t,e){if(!t||!e)return;const i=e.split(".");let n=t;for(const t of i){if(null==n)return;n=n[t]}return n}function createActionHandlerClass(t){return class ActionHandler extends t.ActionHandler{async buildSystemActions(e){if(this.actors=this.actor?[this.actor]:this.#t(),this.tokens=this.token?[this.token]:this.#e(),this.actorType=this.actor?.type,this.displayUnequipped=Utils.getSetting("displayUnequipped"),this.actor){let e=this.actor.items;e=t.Utils.sortItemsByName(e),this.items=e,this.inventoryGroups=this.#i(getInventoryGroupEntries());const i=getTechniqueTypeEntries();this.techniqueGroups=this.#i(i),this.techniqueTypeKeys=new Set(i.flatMap((t=>[t.actorKey??t.id,t.id])))}"character"===this.actorType||"npc"===this.actorType?await this.#n():this.actor||this.#s()}async#n(){await Promise.all([this.#r(),this.#l()]),this.#a(),this.#o(),this.#c(),this.#u()}#s(){if(0===(Array.isArray(this.tokens)?this.tokens:[]).length)return;const e=Array.isArray(this.actors)?this.actors.filter((t=>!!t)):[],i=[],n=t.Utils.i18n?.("tokenActionHud.utility")??game.i18n.localize?.("tokenActionHud.utility")??"Utility",s=t.Utils.i18n?.("tokenActionHud.utility.endTurn")??game.i18n.localize?.("tokenActionHud.utility.endTurn")??"End Turn";if(i.push({id:"endTurn",name:s,encodedValue:["utility","endTurn"].join(this.delimiter),listName:`${n}: ${s}`}),i.length>0){const t={id:"utility",name:n,type:"system"};this.addActions(i,t)}if(0===e.length)return;const r=e[0];if(!r)return;const l=Object.values(game.l5r5e?.HelpersL5r5e?.getRingsList?.(r)??{});if(0===l.length)return;const a=new Set(e.map((t=>t?.system?.stance)).filter((t=>"string"==typeof t))),o=l.map((i=>{try{const n=i.id;if(!n)return null;const s=["ring",n].join(this.delimiter),r=t.Utils.i18n?.(`l5r5e.rings.${n}`)??i.label??n,l=e.map((t=>t?.system?.rings?.[n]?.value)).filter((t=>null!=t));let o=r;if(l.length===e.length&&l.length>0){const t=[...new Set(l)];o=1===t.length?`${r}: ${t[0]}`:`${r}: ${t.join("/")}`}else void 0!==i?.value&&(o=`${r}: ${i.value}`);let c="";1===a.size&&a.has(n)&&(c="toggle active");const u=t.Utils.i18n?.(`l5r5e.conflict.stances.${n}tip`)??"",d=t.Utils.getImage?.(`systems/l5r5e/assets/icons/rings/${n}.svg`),p=l.length?l.join("/"):"";return{id:n,name:o,img:d,encodedValue:s,cssClass:c,tooltip:u,listName:p?`${r}: ${p}`:r}}catch(e){return t.Logger?.error?.(e),null}})).filter((t=>!!t));if(0===o.length)return;const c={id:"rings",name:t.Utils.i18n?.("l5r5e.rings.title")??"rings",type:"system"};this.addActions(o,c)}async#r(){if(!this.items||0===this.items.size)return;const t=new Map,ensureGroup=e=>e?(t.has(e)||t.set(e,new Map),t.get(e)):null;for(const[t,e]of this.items){if(this.#d(e)<=0)continue;const i=this.#p(e),n=null!==i;if(!0===i?ensureGroup("equipped")?.set(t,e):!this.displayUnequipped||n&&!1!==i||ensureGroup("unequipped")?.set(t,e),!this.#f(e,i))continue;const s=this.#g(e);if(0!==s.length)for(const i of s)ensureGroup(i)?.set(t,e)}const e=this.inventoryGroups?[...this.inventoryGroups.keys()]:[],i=[...t.keys()],n=[...new Set([...e,...i])];for(const e of n){const i=t.get(e);if(!i||0===i.size)continue;const n=this.#y(e,this.inventoryGroups);await this.#h(i,n,e)}}#f(t,e){const i=sanitizeId(t?.type),n=new Set(["item","technique","peculiarity"]);return!0===e||!!this.displayUnequipped&&!n.has(i)}#g(t){if(!t)return[];const e=this.inventoryGroups instanceof Map?this.inventoryGroups:new Map,i=this.#m(t),n=new Set(i.map((t=>sanitizeId(t))).filter((t=>t))),s=new Set;for(const[t,i]of e.entries()){const e=new Set([sanitizeId(t),sanitizeId(i?.id),sanitizeId(i?.actorKey),sanitizeId(i?.type)].filter((t=>t)));[i?.aliases,i?.ids,i?.keys,i?.types,i?.values].forEach((t=>{if(!t)return;(Array.isArray(t)?t:t instanceof Set?[...t]:t instanceof Map?[...t.keys(),...t.values()]:"object"==typeof t?Object.values(t):[t]).forEach((t=>{const i=sanitizeId(this.#k(t));i&&e.add(i)}))}));for(const i of n)if(e.has(i)){s.add(t);break}}return s.size>0?[...s]:this.#b(t)}#m(t){const e=t?.system??{},i=[t?.type,e.type,e.itemType,e.item_type,e.inventoryType,e.inventory_type,e.category,e.categoryId,e.category_id,e.group,e.groupId,e.group_id,e.gearType,e.gear_type,e.classification,e.classificationId,e.classification_id,e.subtype,e.sub_type,e.kind,e.technique_type,e.techniqueType];return[e.type,e.category,e.group,e.subtype,e.inventory,e.slot].forEach((t=>{if(!t||"object"!=typeof t)return;[t.id,t.key,t.type,t.value,t.slug,t.name,t.category,t.categoryId,t.group,t.groupId].forEach((t=>{void 0!==t&&i.push(t)}))})),i.map((t=>this.#k(t))).filter((t=>t))}#b(t){const e=sanitizeId(t?.type),i=r?.[e];return i?.groupId?[i.groupId]:[]}#d(t){if(!t)return 0;const e=this.#I(t?.system?.quantity);return null==e?1:e}#p(t){if(!t)return null;const e=this.#A(t?.system?.equipped);if(null!==e)return e;const i=t.system??{},n=[i.readied,i.isEquipped,i.equippedStatus,i.status?.equipped,i.state?.equipped,i.attributes?.equipped,i.equipped_state,i.worn,i.active];for(const t of n){const e=this.#A(t);if(null!==e)return e}return null}#A(t){if(null==t)return null;if("boolean"==typeof t)return t;if("number"==typeof t)return 0!==t;if("string"==typeof t){const e=t.trim().toLowerCase();if(["true","1","yes","equipped","active","enabled","ready","readied","worn"].includes(e))return!0;if(["false","0","no","unequipped","inactive","disabled"].includes(e))return!1}if("object"==typeof t){const e=["value","equipped","isEquipped","active","enabled","state","status","worn","ready","readied"];for(const i of e){if(!Object.hasOwn(t,i))continue;const e=this.#A(t[i]);if(null!==e)return e}}return null}#I(t){if(null==t)return null;if("number"==typeof t)return t;if("string"==typeof t){const e=Number(t);return Number.isNaN(e)?null:e}if(Array.isArray(t)){for(const e of t){const t=this.#I(e);if(null!=t)return t}return null}if(t instanceof Set){for(const e of t.values()){const t=this.#I(e);if(null!=t)return t}return null}if(t instanceof Map){for(const e of t.values()){const t=this.#I(e);if(null!=t)return t}return null}if("object"==typeof t){const e=["value","current","count","number","amount","quantity","total","max","min"];for(const i of e){if(!Object.hasOwn(t,i))continue;const e=t[i];if(e===t)continue;const n=this.#I(e);if(null!=n)return n}}return null}#k(t){if(null==t)return null;if("string"==typeof t||"number"==typeof t)return String(t);if(Array.isArray(t)){for(const e of t){const t=this.#k(e);if(t)return t}return null}if(t instanceof Set){for(const e of t.values()){const t=this.#k(e);if(t)return t}return null}if(t instanceof Map){for(const e of t.values()){const t=this.#k(e);if(t)return t}return null}if("object"==typeof t){const e=["id","key","value","type","slug","name","category","categoryId","group","groupId"];for(const i of e){if(!Object.hasOwn(t,i))continue;const e=this.#k(t[i]);if(e)return e}}return null}#v(t){if(!t)return null;if(this.items?.has(t))return this.items.get(t);if("string"==typeof t){const e=t.includes(".")?t.split(".").pop():t;if(e&&this.items?.has(e))return this.items.get(e);const i=[...this.items.values()].find((e=>e?.uuid===t));if(i)return i}return null}#a(){const e="ring",i=game.l5r5e.HelpersL5r5e.getRingsList(this.actor);if(0===i.length)return;const n=this.actor.system.stance,s={id:"rings",name:`${t.Utils.i18n("l5r5e.rings.title")}`??"rings",type:"system"},r=Object.values(i).map((i=>{try{const s=i.id,r=[e,s].join(this.delimiter),l=`${t.Utils.i18n(`l5r5e.rings.${s}`)}: ${i.value}`??"",a=`${`${i.label}:`??""}${l}`,o=t.Utils.getImage(`systems/l5r5e/assets/icons/rings/${s}.svg`),c=`${t.Utils.i18n(`l5r5e.conflict.stances.${s}tip`)}`;let u="";return s===n&&(u="toggle active"),{id:s,name:l,img:o,encodedValue:r,cssClass:u,tooltip:c,listName:a}}catch(e){return t.Logger.error(i),null}})).filter((t=>!!t));this.addActions(r,s)}#u(){if(!["character","npc"].includes(this.actorType))return;const e="skill",i=this.#S();for(const n of i){const i=n.id;try{const s={id:i,name:n.label,type:"system"},r=n.skills.map((s=>{const r=[e,s].join(this.delimiter),l=this.#x(i,s),a=n.skillLabels instanceof Map?n.skillLabels.get(s)??n.skillLabels.get(String(s)):n.skillLabels?.[s]??n.skillLabels?.[String(s)],o=this.#q(i,s,a),c=""!==l&&null!=l?`${o}: ${l}`:o;return{id:s,name:c,encodedValue:r,listName:`${`${t.Utils.i18n("l5r5e.skills.label")}: `??""}${c}`}}));this.addActions(r,s)}catch(e){return t.Logger.error(i),null}}}#S(){const t=game.l5r5e?.HelpersL5r5e??{},e="npc"===this.actorType?this.#L(t,!0):this.#L(t,!1);return this.#H(e).map((t=>{if(!t||!t.id||!t.skills||0===t.skills.length)return null;const e=this.#w(t.id,t.label);return{id:t.id,label:e,skills:t.skills,skillLabels:t.skillLabels}})).filter((t=>t&&t.skills.length>0))}#H(t){if(!t)return[];const e=[],addEntry=(t,i)=>{const n=this.#C(t,i);n&&n.id&&e.push(n)};if(t instanceof Map){for(const[e,i]of t.entries())addEntry(i,e);return e}return Array.isArray(t)?(t.forEach(((t,e)=>addEntry(t,e))),e):"object"==typeof t?(Object.entries(t).forEach((([t,e])=>addEntry(e,t))),e):[]}#C(t,e){if(null==t)return null;const i="string"==typeof e||"number"==typeof e?String(e):void 0;if(Array.isArray(t)&&t.length>0){if(t.length>=2){const[e,n,s]=t,{ids:r,labels:l}=this.#T(n);return{id:"string"==typeof e||"number"==typeof e?String(e):i,label:"string"==typeof s?s:t.label??t.name??null,skills:r,skillLabels:l}}const{ids:e,labels:n}=this.#T(t);return{id:i,label:t.label??t.name??null,skills:e,skillLabels:n}}if(t instanceof Set||t instanceof Map){const{ids:e,labels:n}=this.#T(t);return{id:i,label:t.label??t.name??t.title??null,skills:e,skillLabels:n}}if("object"==typeof t){const e="string"==typeof t.id||"number"==typeof t.id?String(t.id):"string"==typeof t.key||"number"==typeof t.key?String(t.key):"string"==typeof t.category||"number"==typeof t.category?String(t.category):"string"==typeof t.type||"number"==typeof t.type?String(t.type):i,n=t.label??t.name??t.title??t.categoryLabel??t.categoryName??null,s=t.skills??t.skillIds??t.skill_ids??t.skillList??t.skill_list??t.skillGroups??t.skill_groups??t.values??t.entries??t.list??t.items??t.data??t.set??t.group,{ids:r,labels:l}=this.#T(s??t);return{id:e,label:n,skills:r,skillLabels:l}}if("string"==typeof t||"number"==typeof t){const{ids:e,labels:n}=this.#T([t]);return{id:i??(1===e.length?e[0]:String(t)),label:null,skills:e,skillLabels:n}}return null}#T(t){const e=[],i=new Map,addSkill=(t,n)=>{if(null==t)return;const s=String(t);s&&(e.push(s),n&&!i.has(s)&&i.set(s,String(n)))},visit=(t,e)=>{if(null!=t)if(t instanceof Set)t.forEach((t=>visit(t)));else if(t instanceof Map)for(const[e,i]of t.entries())if("object"==typeof i&&null!==i){const t=i.id??i.key??i.skill??i.slug??i.value??e,n=i.label??i.name??i.title??null;void 0!==t&&addSkill(t,n),visit(i.skills??i.skill??i.values??i.entries??i.list??i.items,null)}else visit(i,e);else if(Array.isArray(t))t.forEach((t=>{if(Array.isArray(t))visit(t);else if("object"==typeof t&&null!==t){const i=t.id??t.key??t.skill??t.slug??t.value??t.default??t.primary??e,n=t.label??t.name??t.title??t.displayName??null;void 0!==i&&addSkill(i,n);const s=t.skills??t.skill??t.values??t.entries??t.list??t.items;s&&visit(s)}else visit(t)}));else if("object"!=typeof t)"string"!=typeof t&&"number"!=typeof t||addSkill(t);else{const i=t.id??t.key??t.skill??t.slug??t.value??t.default??t.primary??e,n=t.label??t.name??t.title??t.displayName??null;void 0!==i&&addSkill(i,n);const s=["skill","skills","ids","id","keys","key","values","value","default","primary","entries","list","items","options","choices"];for(const e of s)void 0!==t[e]&&visit(t[e])}};return visit(t),{ids:this.#$(e),labels:i}}#D(t){return t?t instanceof Map?this.#$([...t.values()]):Array.isArray(t)?this.#$(t.flatMap((t=>this.#D(t)))):"string"==typeof t?this.#$([t]):"object"==typeof t?t.id?this.#D(t.id):t.key?this.#D(t.key):t.value?this.#D(t.value):t.default?this.#D(t.default):t.skills?this.#D(t.skills):t.entries?this.#D(t.entries):t.list?this.#D(t.list):t.items?this.#D(t.items):this.#$(Object.values(t).flatMap((t=>this.#D(t)))):[]:[]}#$(t){return[...new Set(t.map((t=>null==t?"":String(t))).filter((t=>t)))]}#w(t,e){if(e)return e;const i=game.l5r5e?.HelpersL5r5e,n=["getSkillCategoryLabel","getNpcSkillCategoryLabel"];for(const e of n){const n=i?.[e];if("function"==typeof n)try{const e=n.call(i,t,this.actor);if(e)return e}catch(t){continue}}const s=CONFIG?.l5r5e??{},r=s?.npc?.skills?.[t]??s?.skills?.[t];if(r){const t=r.label??r.name??r.title;if(t)return t}const l=[`l5r5e.npc.skills.${t}.title`,`l5r5e.skills.${t}.title`,`l5r5e.skills.${t}`,t];return this.#O(l)}#q(t,e,i){if(i)return i;const n=game.l5r5e?.HelpersL5r5e,s=[["getNpcSkillLabel",[t,e]],["getNpcSkillLabel",[e]],["getSkillLabel",[t,e]],["getSkillLabel",[e]],["getSkillName",[e]],["getSkillNameFromId",[e]]];for(const[t,e]of s){const i=n?.[t];if("function"==typeof i)try{const t=i.apply(n,e);if(t)return t}catch(t){continue}}const r=CONFIG?.l5r5e??{},l=r?.npc?.skills?.[t]?.[e]??r?.skills?.[t]?.[e]??r?.skills?.[e];if(l){const t=l.label??l.name??l.title;if(t)return t}const a=[`l5r5e.npc.skills.${t}.${e}`,`l5r5e.skills.${t}.${e}`,`l5r5e.skills.${e}`,`l5r5e.skill.${e}`,e];return this.#O(a)}#x(t,e){const i=[this.actor?.system?.skills,this.actor?.system?.npcSkills,this.actor?.system?.npc?.skills,this.actor?.system?.npc?.skillCategories,this.actor?.system?.npc?.skill_categories,this.actor?.system?.npc?.skillGroups,this.actor?.system?.npc?.skill_groups,this.actor?.system?.skillRanks,this.actor?.system?.skillGroups,this.actor?.system?.skill_groups];for(const n of i){const i=n?.[t];if(!i)continue;const s=i?.[e],r=this.#P(s);if(null!=r)return r}const n=this.actor?.system?.skills?.[e],s=this.#P(n);return null!=s?s:""}#L(t,e=!1){const i=this.actor,n=e?["getNpcSkillCategoriesList","getNpcSkillCategories","getNpcSkillsCategoriesList","getNpcSkillsCategories","getNpcSkillsList","getNpcSkills","getNpcSkillGroupsList","getNpcSkillGroups"]:["getCategoriesSkillsList","getSkillCategoriesList","getSkillsCategoriesList","getSkillsList","getSkillCategories"],s=Object.keys(t??{}).filter((t=>{const i=t.toLowerCase();return!!i.includes("skill")&&(!(e&&!i.includes("npc"))&&(!(!e&&i.includes("npc"))&&(i.includes("list")||i.includes("categor")||i.includes("group"))))})),r=new Set,l=[...n,...s];for(const e of l){if(r.has(e))continue;r.add(e);const n=t?.[e],s=this.#_(n,t,i);if(s)return s}const a=e?["system.npc.skills","system.npcSkills","system.skills","system.npc.skillCategories","system.npc.skill_categories","system.npc.skillGroups","system.npc.skill_groups"]:["system.skills","system.skillCategories","system.skill_categories","system.skillGroups","system.skill_groups"];for(const t of a){const e=this.#j(i,t);if(e)return e}return e?i?.system?.npcSkills??i?.system?.skills:i?.system?.skills}#_(t,e,i){if("function"!=typeof t)return null;const n=[[i],[i,{actor:i}],[]];for(const i of n)try{const n=t.apply(e,i);if(n)return n}catch(t){continue}return null}#P(t){if(null==t)return null;if("number"==typeof t||"string"==typeof t)return t;if("object"==typeof t)for(const e of["value","rank","dice","level","rating"])if(void 0!==t[e])return t[e];return null}#O(e){for(const i of e){if(!i)continue;const e=t.Utils.i18n(i);if(e&&e!==i)return e}return e[e.length-1]??""}async#l(t){if(0===this.items.size)return;const e=new Map;for(const[t,i]of this.items){if(this.#R(i)){const n=this.#E(i)??sanitizeId(i.type);if(!n)continue;e.has(n)||e.set(n,new Map),e.get(n).set(t,i)}}const i=this.techniqueGroups?[...this.techniqueGroups.keys()]:[],n=[...e.keys()],s=[...new Set([...i,...n])];for(const t of s){const i=e.get(t);if(!i||0===i.size)continue;const n=this.#y(t,this.techniqueGroups,{fallbackPrefix:"l5r5e.techniques"});await this.#h(i,n,"technique")}}#t(){const e=["character","npc"],i=t.Utils.getControlledTokens()?.filter((t=>t.actor)).map((t=>t.actor));return i.every((t=>e.includes(t.type)))?i:[]}#e(){const e=["character","npc"],i=t.Utils.getControlledTokens(),n=i?.filter((t=>t.actor)).map((t=>t.actor));return n.every((t=>e.includes(t.type)))?i:[]}#R(t){if(!t)return!1;const e=sanitizeId(t.type),i=this.#E(t);return this.techniqueTypeKeys&&0!==this.techniqueTypeKeys.size?!(!e||!this.techniqueTypeKeys.has(e))||!(!i||!this.techniqueTypeKeys.has(i)):"technique"===e||!!i}#E(t){if(!t)return null;const e=t.system??{},i=[e.technique_type,e.techniqueType,e.technique?.type,e.type,e.category,e.group,e.subtype];for(const t of i){const e=this.#k(t);if(e)return sanitizeId(e)}return null}#o(){this.#U("derived")}#c(){this.#U("standing")}#U(t){if(!this.actor)return;const{entries:e,section:i}=getAttributeEntries(t,this.actor);if(0===e.length)return;const n=e.map((e=>this.#N(e,i,t))).filter((t=>!!t));if(0===n.length)return;const s=this.#z(t);this.addActions(n,s)}#N(e,i,r){const l=this.#M(i,e,r);if(void 0===l)return null;const a=this.#K(l),o=""!==a,c=this.#G(e,r),u=o?`${c}: ${a}`:c,d=t.Utils.i18n(n[r]??s?.[r]?.name??""),p=d?`${d}: ${u}`:u,f=[r,e.actorKey??e.id].join(this.delimiter),g={id:e.id,name:u,encodedValue:f,listName:p};return o&&(g.info1={text:a}),g}#M(t,e,i){const n=this.#V(t,i),s=[];e.path&&s.push(e.path);[e.actorKey,e.id].forEach((t=>{t&&(s.push(t),s.push(String(t).replace(/-/g,"_")))}));for(const t of n)for(const e of s){const i=this.#j(t,e);if(void 0!==i)return i}}#V(t,e){const i=[];t&&"object"==typeof t&&i.push(t);const n=this.actor?.system??{},s="standing"===e?["standing","social","attributes.standing","attributes.social"]:["derived","derivedAttributes","attributes.derived","attributes.derivedAttributes"];for(const t of s){const e=this.#j(n,t);e&&"object"==typeof e&&!i.includes(e)&&i.push(e)}return n&&"object"==typeof n&&!i.includes(n)&&i.push(n),i}#K(t){if(null==t)return"";if("number"==typeof t||"string"==typeof t)return String(t);const e=this.#B(t.value,t.current,t.rank,t.score,t.points,t.amount,t.total),i=this.#B(t.max,t.maximum,t.cap,t.limit,t.maxValue,t.maximumValue);if(void 0!==e&&void 0!==i)return`${e}/${i}`;if(void 0!==e)return String(e);if(void 0!==t.current&&void 0!==t.max)return`${t.current}/${t.max}`;if(void 0!==t.current)return String(t.current);if(void 0!==t.rank&&void 0!==t.cap)return`${t.rank}/${t.cap}`;if(void 0!==t.rank)return String(t.rank);const n=Object.values(t).filter((t=>"number"==typeof t));return 1===n.length?String(n[0]):n.length>1?n.join("/"):""}#G(e,i){const n=e.translationKey;if(n)return t.Utils.i18n(n);if(e.label)return t.Utils.i18n(e.label);const s="standing"===i?"l5r5e.social":"l5r5e.attributes",r=e.actorKey??e.id;if(r){const e=`${s}.${String(r).replace(/-/g,"_").toLowerCase()}`;return t.Utils.i18n(e)}return e.id}#y(e,i,{fallbackPrefix:n}={}){const r=i?.get(e);let l=r?.translationKey,a=r?.label;if(!l&&n){l=`${n}.${String(r?.actorKey??e).replace(/-/g,"_").toLowerCase()}`}const o=s?.[e]?.name;return{id:e,name:l?t.Utils.i18n(l):a?t.Utils.i18n(a):o?t.Utils.i18n(o):this.#F(e),type:"system"}}#z(e){const i=e,n=s?.[i]?.name;return{id:i,name:n?t.Utils.i18n(n):i,type:"system"}}#B(...t){return t.find((t=>null!=t))}#j(t,e){if(!t||!e)return;if(Object.hasOwn(t,e))return t[e];const i=String(e).split(".");let n=t;for(const t of i){if(null==n)return;n=n[t]}return n}#i(t){return new Map(t.map((t=>[t.id,t])))}#F(t){return String(t??"").split(/[-_]/).filter((t=>t.length>0)).map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" ")}async#h(t,e,i="item"){if(0===t.size)return;if(!("string"==typeof e?e:e?.id))return;const n=await Promise.all([...t].map((async t=>await this.#W(i,t[1]))));this.addActions(n,e)}async#W(e,i){const s=i.id??i._id;let r=i?.name??i?.label;const l=`${`${t.Utils.i18n(n[e])}: `??""}${r}`;let a="";if(Object.hasOwn(i.system,"readied")){a=`toggle${i.system.readied?" active":""}`}const o=[e,s].join(this.delimiter),c=t.Utils.getImage(i),u=this.#Q(i?.system?.activation?.type);let d=this.#Z(i);const p=d?.info1,f=d?.info2,g=d?.info3,y=await this.#J(i);return{id:s,name:r,encodedValue:o,cssClass:a,img:c,icon1:u,icon2:null,info1:p,info2:f,info3:g,listName:l,tooltip:await this.#X(y)}}#Q(t){}#Z(t){return{info1:{text:this.#Y(t)},info2:{text:this.#tt(t)},info3:{text:this.#et(t)}}}#Y(t){const e=this.#I(t?.system?.quantity);return null==e?"":e>1?e:""}#tt(t){const e=t?.system?.uses??t?.system?.ammo;if(!e)return"";const i=this.#I(e.value??e.current??e.count??e),n=this.#I(e.max??e.total??e.capacity),s=null!=i,r=null!=n&&n>0;if(!s&&!r)return"";const l=s?i:0;return r?`${l}/${n}`:`${l}`}#et(t){const e=t?.system?.consume??{},i=e?.target??e?.id??e?.uuid,n=e?.type??e?.mode;if(i===t.id||i===t.uuid)return"";if("attribute"===n){if(!i)return"";const t=this.actor?.system??{},e=String(i).startsWith("system.")?String(i).slice(7):String(i);let n=this.#j(t,e);if(!n&&e.includes(".")){const i=e.substring(0,e.lastIndexOf("."));n=this.#j(t,i)}if(!n&&!e.includes(".")){const i=[`attributes.${e}`,`attributes.derived.${e}`,`attributes.standing.${e}`,`derived.${e}`,`standing.${e}`,e];for(const e of i)if(n=this.#j(t,e),n)break}if(!n)return"";const s=this.#I(n?.value??n?.current??n),r=this.#I(n?.max??n?.maximum??n?.limit);return null!=r&&r>0?`${s??0}/${r}`:null!=s?`${s}`:""}const s=this.#v(i);if("charges"===n){const t=s?.system?.uses??s?.system?.ammo;if(!t)return"";const e=this.#I(t.value??t.current??t),i=this.#I(t.max??t.total??t.capacity);return null===e&&null===i?"":null!=i&&i>0?`${e??0}/${i}`:null!=e?`${e}`:""}const r=this.#I(s?.system?.quantity);return null==r?"":r>0?`${r}`:""}async#J(t){if("none"===this.tooltipsSetting)return"";const e=t?.name??"";if("nameOnly"===this.tooltipsSetting)return e;const i="string"==typeof t?.system?.description?t?.system?.description:t?.system?.description?.value??"",n=t?.modifiers??null,s=[...t?.system?.chatProperties??[],...t?.system?.equippableItemCardProperties??[],...t?.system?.activatedEffectCardProperties??[]].filter(Boolean),r=t?.type;return{name:e,type:r,description:i,modifiers:n,properties:s,rarity:t?.system?.rarity?.value??t?.system?.rarity??null,traits:this.#it(t?.system?.properties),patterns:this.#nt(t?.system?.patterns),tags:this.#st(t?.system?.tags),bonuses:this.#rt(t?.system?.bonuses),range:"weapon"===r?t?.system?.range?.value??t?.system?.range:null,damage:"weapon"===r?t?.system?.damage?.value??t?.system?.damage:null,deadliness:"weapon"===r?t?.system?.deadliness?.value??t?.system?.deadliness:null,grip1:"weapon"===r?t?.system?.grip_1?.value??t?.system?.grip_1:null,grip2:"weapon"===r?t?.system?.grip_2?.value??t?.system?.grip_2:null,physical:"armor"===r?t?.system?.armor?.physical?.value??t?.system?.armor?.physical:null,supernatural:"armor"===r?t?.system?.armor?.supernatural?.value??t?.system?.armor?.supernatural:null}}#it(e){const i=this.#lt(e);if(!i.length)return null;const n=i.map((e=>{if(!e)return null;const i="object"==typeof e?e:{id:e},n=this.#at(i?.id??i?.key??i?.slug??i?.name);if(!n)return null;if(!(!1!==(i?.active??i?.enabled??i?.value??!0)))return null;const s=a[n],r=i?.label??i?.name??this.#ot(n);if(!s&&!r)return null;if(!s)return r;const l=t.Utils.i18n(s);return l&&l!==s?l:r??s})).filter(Boolean);return n.length?n:null}async#X(e){if("none"===this.tooltipsSetting)return"";if("string"==typeof e)return e;const i=t.Utils.i18n(e.name);if("nameOnly"===this.tooltipsSetting)return i;const n=`<h3>${i}</h3>`,s=e?.descriptionLocalised??await TextEditor.enrichHTML(t.Utils.i18n(e?.description??""),{async:!0}),r=e?.traits?.length?`<div class="tah-properties">${e.traits.map((t=>`<span class="tah-property">${t}</span>`)).join("")}</div>`:"",l=[e?.rarity?[{label:"tokenActionHud.l5r5e.tooltip.rarity",value:e.rarity,class:this.#ct(e.rarity)}]:[],"weapon"===e.type?this.#ut(e):[],"weapon"===e.type?this.#dt(e):[],"armor"===e.type?this.#pt(e):[],e.patterns??[],e.tags??[],e.bonuses??[]].flat(),a=this.#ft(l);return s||a?`<div>${n}${a?`<div class="tah-tags-wrapper">${a??""}</div>`:""}${s}${r}</div>`:i}#ct(t){return t?t<3?"common":t<5?"uncommon":t<7?"rare":t<9?"veryRare":9==t?"legendary":10==t?"artifact":void 0:""}#ut(t){return[t.range?{label:"l5r5e.weapons.range",value:t.range}:null,t.damage?{label:"l5r5e.weapons.damage",value:t.damage}:null,t.deadliness?{label:"l5r5e.weapons.deadliness",value:t.deadliness}:null].filter(Boolean)}#dt(t){return[t.grip1&&"N/A"!==t.grip1?{label:"l5r5e.weapons.1hand",value:t.grip1}:null,t.grip2&&"N/A"!==t.grip2?{label:"l5r5e.weapons.2hand",value:t.grip2}:null].filter(Boolean)}#pt(t){return[t?.physical&&t?.physical>0?{label:"l5r5e.armors.physical",value:t?.physical}:null,t?.supernatural&&t?.supernatural>0?{label:"l5r5e.armors.supernatural",value:t?.supernatural}:null].filter(Boolean)}#nt(t){const e=this.#lt(t);if(!e.length)return null;const i=c.pattern??c.default,n=i?.icon??c.default?.icon,s=i?.class??c.default?.class,r=e.map((t=>{if(!t)return null;const e="object"==typeof t?t:{id:t},i=this.#at(e?.id??e?.key??e?.slug??e?.name);if(!i)return null;if(!(!1!==(e?.active??e?.enabled??e?.value??!0)))return null;const r=o[i],l=e?.label??e?.name??this.#ot(i);return r||l?{label:r??l,localized:!r&&Boolean(l),fallback:l,icon:n,class:s}:null})).filter(Boolean);return r.length?r:null}#st(t){const e=this.#lt(t);if(!e.length)return null;const i=e.map((t=>{if(!t)return null;const e="object"==typeof t?t:{id:t},i=this.#at(e?.id??e?.key??e?.slug??e?.type??e?.name);if(!i)return null;if(!(!1!==(e?.active??e?.enabled??e?.value??!0)))return null;const n=c[i]??c.default,s=n?.label??(i?`tokenActionHud.l5r5e.tags.${i}`:null),r=e?.label??e?.name??this.#ot(i),l=e?.amount??e?.rating??e?.value,a="number"==typeof l||"string"==typeof l?l:void 0;return s||r?{label:s??r,localized:!s&&Boolean(r),fallback:r,value:a,icon:n?.icon??c.default?.icon,class:n?.class??c.default?.class}:null})).filter(Boolean);return i.length?i:null}#rt(t){const e=this.#lt(t);if(!e.length)return null;const i=c.bonus??c.default,n=e.map((t=>{if(!t)return null;const e="object"==typeof t?t:{id:t},n=this.#at(e?.id??e?.key??e?.slug??e?.type??e?.name);if(!n)return null;if(!(!1!==(e?.active??e?.enabled??!0)))return null;const s=u[n]??i,r=s?.label??(n?`tokenActionHud.l5r5e.bonuses.${n}`:null),l=e?.label??e?.name??this.#ot(n),a=e?.value??e?.amount??e?.bonus??e?.rating,o="number"==typeof a||"string"==typeof a?a:void 0;return r||l||void 0!==o?{label:r??l,localized:!r&&Boolean(l),fallback:l,value:o,icon:s?.icon??i?.icon,class:s?.class??i?.class}:null})).filter(Boolean);return n.length?n:null}#ft(t){if(!t||0===t.length)return"";const e=t.map((t=>this.#gt(t))).filter(Boolean).join("");return e?`<div class="tah-tags">${e}</div>`:""}#gt(e){if(!e)return"";const i=["tah-tag"];e.class&&i.push(e.class);const n=i.filter(Boolean).join(" "),s=e.icon?`<i class="${e.icon}" aria-hidden="true"></i>`:"";if(e.text)return`<span class="${n}">${s}${s?`<span class="tah-tag-text">${e.text}</span>`:e.text}</span>`;const r=e.label??"";let l="";if(e.localized?l=r:r&&(l=t.Utils.i18n(r),e.fallback&&l===r&&(l=e.fallback)),l||(l=e.fallback??""),!l)return"";const a=void 0!==e.value&&null!==e.value&&""!==e.value?`${l}: ${e.value}`:l;return`<span class="${n}"${e.title?` title="${e.title}"`:""}>${s?`${s}<span class="tah-tag-text">${a}</span>`:a}</span>`}#lt(t){return t?Array.isArray(t)?t.filter((t=>null!=t)):t instanceof Map?Array.from(t.entries()).map((([t,e])=>"object"==typeof e&&null!==e?{id:t,...e}:{id:t,value:e})):t instanceof Set?[...t]:"object"==typeof t?Object.entries(t).map((([t,e])=>"object"==typeof e&&null!==e?{id:t,...e}:{id:t,value:e})):[t]:[]}#at(t){if(null==t)return"";return("string"==typeof t?t:String(t)).trim().replace(/\s+/g,"_").replace(/[A-Z]/g,(t=>`_${t.toLowerCase()}`)).replace(/[-]+/g,"_").replace(/__+/g,"_").replace(/^_+|_+$/g,"")}#ot(t){return t&&"string"==typeof t?t.replace(/[-_]/g," ").replace(/\s+/g," ").trim().replace(/\b\w/g,(t=>t.toUpperCase())):""}}}function getCoreModule(){const t=game.modules.get(e.ID);if(!t)throw new Error("Token Action HUD Core module is not available. Please ensure it is installed and active.");return t}function getCoreApi(){const t=getCoreModule();if(!t.api)throw new Error("Token Action HUD Core API is not available. Ensure you are using Token Action HUD Core 2.x or later.");return t.api}let g=null;function createRollHandlerClass(t){return class RollHandler extends t.RollHandler{async handleActionClick(t,e){const[i,n]=e.split("|"),s="function"==typeof this.isRenderItem&&this.isRenderItem(t),r=s||"contextmenu"===t?.type||2===t?.button||2===t?.data?.button||!0===t?.data?.isRightClick;if(["item","weapons","technique","armor"].includes(i)&&s)return this.doRenderItem(this.actor,n);if(["ring"].includes(i)&&r&&"ring"===i)return void await this.#yt(t,this.actor,n);const l=["character"];if(this.actor)return void await this.#ht(t,this.actor,this.token,i,n);const a=canvas.tokens.controlled.filter((t=>l.includes(t.actor?.type)));for(const e of a){const s=e.actor;await this.#ht(t,s,e,i,n)}}async handleActionHover(t,e){}async handleGroupClick(t,e){}async#ht(t,e,i,n,s){switch(n){case"weapons":this.#mt(t,e,i,s);break;case"ring":this.#kt(t,e,i,s);break;case"skill":this.#bt(t,e,i,s);break;case"technique":this.#It(t,e,i,s);break;case"armor":case"equipment":await this.#At(t,e,s,i);break;case"utility":this.#vt(i,s)}}async#At(t,e,i,n){const s=e.items.get(i);if(!s)return;const r=game.l5r5e??{},l=r.HelpersL5r5e??{},a=r.Chat??r.chat??{},o=r.applications?.chat??r.apps?.chat??{},c=r.ChatMessage??{},u="function"==typeof ChatMessage?.getSpeaker?ChatMessage.getSpeaker({actor:e,token:n}):{actor:e?.id,token:n?.id},d={actor:e,token:n,speaker:u,item:s,source:"token-action-hud"},p=[{fn:l.sendItemToChat,context:l},{fn:l.sendToChat,context:l},{fn:l.displayItem,context:l},{fn:a.sendItemToChat,context:a},{fn:a.displayItem,context:a},{fn:a.createItemMessage,context:a},{fn:a.showItemCard,context:a},{fn:a.renderItemCard,context:a},{fn:o.sendItemToChat,context:o},{fn:o.displayItem,context:o},{fn:o.renderItemCard,context:o},{fn:c.createItemMessage,context:c},{fn:c.sendItemToChat,context:c},{fn:r.ChatV2?.createItemMessage,context:r.ChatV2},{fn:s?.sendToChat,context:s},{fn:s?.displayCard,context:s},{fn:s?.showItemCard,context:s},{fn:s?.toMessage,context:s}].filter((t=>"function"==typeof t?.fn));for(const t of p)try{const{fn:i,context:r}=t,l="number"==typeof i.length?i.length:1;let a;if(r===s&&i===s?.toMessage){const t={speaker:u};a=await i.call(r,t,{create:!0})}else a=r===s?l<=0?await i.call(r):1===l?await i.call(r,d):await i.call(r,d,{create:!0}):l<=1?await i.call(r,s):2===l?await i.call(r,s,d):await i.call(r,s,d,{actor:e,token:n});if(!1!==a)return}catch(t){continue}"function"==typeof ChatMessage?.create?await ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:e}),content:game.i18n.format("tokenActionHud.l5r5e.itemChatFallback",{item:s.name})}):ui.notifications?.warn(game.i18n.format("tokenActionHud.l5r5e.itemChatFallback",{item:s.name}))}async#yt(t,e,i){const n=["character","npc"],s=Object.keys(CONFIG.l5r5e?.conflict?.stances??{});if(s.length>0&&!s.includes(i))return;const r=e?[e]:canvas.tokens.controlled.map((t=>t.actor)).filter((t=>t&&n.includes(t.type)));if(r&&0!==r.length)for(const t of r)if(n.includes(t.type)&&t.system?.stance!==i&&t.canUserModify?.(game.user,"update"))try{await t.update({"system.stance":i})}catch(t){console.error(t)}}async#mt(t,e,i,n){const s=e?.items?.get(n)??e?.items?.find?.((t=>t?.uuid===n));if(!s)return;const r=this.#St(s?.system?.skill),l=this.#xt(s?.system?.ring),a=s?.system?.tn??s?.system?.difficulty??null,o={event:t,item:s,itemId:s.id,sourceId:s.id,type:s.type,itemType:s.type,title:s.name,difficulty:a,context:"token-action-hud"};r.length>0&&(o.skill=o.skill??r[0],o.skillId=o.skillId??r[0],o.skills=o.skills??r,o.skillsList=o.skillsList??r),l&&(o.ring=o.ring??l,o.ringId=o.ringId??l);const c=this.#qt(e,i,o);await this.#Lt(e,s,c)||await this.#Ht(e,c,i,{prepared:!0})}async#kt(t,e,i,n){const s={event:t,ring:n,ringId:n,context:"token-action-hud"},r=this.#qt(e,i,s);await this.#wt(e,n,r)||await this.#Ht(e,r,i,{prepared:!0})}async#bt(t,e,i,n){const s={event:t,skill:n,skillId:n,context:"token-action-hud"},r=this.#qt(e,i,s);await this.#Ct(e,n,r)||await this.#Ht(e,r,i,{prepared:!0})}async#It(t,e,i,n){const s=e?.items?.get(n)??e?.items?.find?.((t=>t?.uuid===n));if(!s)return;const r=this.#St(s?.system?.skill),l=this.#xt(s?.system?.ring),a=s?.system?.difficulty??s?.system?.tn??null,o={event:t,item:s,itemId:s.id,sourceId:s.id,type:s.type,itemType:s.type,title:s.name,difficulty:a,context:"token-action-hud"};r.length>0&&(o.skill=o.skill??r[0],o.skillId=o.skillId??r[0],o.skills=o.skills??r,o.skillsList=o.skillsList??r),l&&(o.ring=o.ring??l,o.ringId=o.ringId??l);const c=this.#qt(e,i,o);await this.#Lt(e,s,c)||await this.#Ht(e,c,i,{prepared:!0})}async#Ht(t,e={},i,{prepared:n=!1}={}){const s=n?this.#Tt(e):this.#qt(t,i,e),r=this.#$t();if(!r){const t=game.i18n?.localize?.("tokenActionHud.l5r5e.dicePickerError"),e=game.i18n?.localize?.("tokenActionHud.notifications.dicePickerError"),i=t&&"tokenActionHud.l5r5e.dicePickerError"!==t?t:e&&"tokenActionHud.notifications.dicePickerError"!==e?e:"Token Action HUD L5R5e: Unable to open Dice Picker Dialog";return ui.notifications?.warn?.(i),null}const l=[["show",[[s],[t,s],[s,t]]],["open",[[s],[t,s],[s,t]]],["create",[[s],[t,s],[s,t]]],["launch",[[s],[t,s],[s,t]]],["render",[[s]]]];for(const[t,e]of l){const i=r?.[t];if("function"==typeof i)for(const t of e)try{const e=i.apply(r,t);if(void 0!==e)return e}catch(t){continue}}const a=[];a.push([s]),a.push([t,s]),a.push([s,t]),a.push([s,{actor:t}]),a.push([{actor:t,options:s}]),s.context&&(a.push([t,s,s.context]),a.push([s,t,s.context]));const o="number"==typeof r.length?r.length:null,c=o&&o>0?a.filter((t=>t.length===o)):a;for(const t of c)try{const e=new r(...t);return"function"==typeof e?.render?e.render(!0):"function"==typeof e?.open&&e.open(s),e}catch(t){continue}const u=game.i18n?.localize?.("tokenActionHud.l5r5e.dicePickerError"),d=game.i18n?.localize?.("tokenActionHud.notifications.dicePickerError"),p=u&&"tokenActionHud.l5r5e.dicePickerError"!==u?u:d&&"tokenActionHud.notifications.dicePickerError"!==d?d:"Token Action HUD L5R5e: Unable to open Dice Picker Dialog";return ui.notifications?.warn?.(p),null}#qt(t,e,i={}){const n=this.#Tt(i);n.context||(n.context="token-action-hud"),t&&!n.actor&&(n.actor=t),t?.id&&!n.actorId&&(n.actorId=t.id),t?.uuid&&!n.actorUuid&&(n.actorUuid=t.uuid),t?.type&&!n.actorType&&(n.actorType=t.type),e&&!n.token&&(n.token=e);const s=e?.document??e;s?.id&&!n.tokenId&&(n.tokenId=s.id),s?.uuid&&!n.tokenUuid&&(n.tokenUuid=s.uuid),s?.scene?.id&&!n.sceneId&&(n.sceneId=s.scene.id),s?.scene?.uuid&&!n.sceneUuid&&(n.sceneUuid=s.scene.uuid),n.item&&!n.itemId&&(n.itemId=n.item.id),n.item&&!n.sourceId&&(n.sourceId=n.sourceId??n.item.id),n.item&&!n.itemType&&(n.itemType=n.item.type),n.item?.uuid&&!n.itemUuid&&(n.itemUuid=n.item.uuid),n.item&&!n.title&&(n.title=n.item.name);const r=this.#Dt([n.skill,n.skillId,...Array.isArray(n.skills)?n.skills:[],...Array.isArray(n.skillsList)?n.skillsList:[]]);r.length>0&&(n.skill=r[0],n.skillId=r[0],n.skillKey=n.skillKey??r[0],n.skills=r,n.skillsList=r);const l=this.#xt(n.ring??n.ringId??n.ringKey);l&&(n.ring=l,n.ringId=l,n.ringKey=l);const a=this.#Ot(n.targetNumber)??this.#Ot(n.tn)??this.#Ot(n.difficulty);null!==a&&(n.difficulty=a,n.tn=a,n.targetNumber=a);const o={};return r.length>0&&(o.skill=r[0],o.skillId=r[0],o.skillKey=r[0]),l&&(o.ring=l,o.ringId=l,o.ringKey=l),null!==a&&(o.tn=a,o.difficulty=a,o.targetNumber=a),n.action=n.action?{...o,...n.action}:{...o},n.check=n.check?{...o,...n.check}:{...o},n.dicePool=n.dicePool?{...o,...n.dicePool}:{...o},n.pool=n.pool?{...o,...n.pool}:{...o},n}async#Ct(t,e,i){if(!t||!e)return!1;const n=this.#Pt(e,t,i),s=[{fn:t?.rollSkill,context:t,argsList:n},{fn:t?.rollSkillCheck,context:t,argsList:n},{fn:t?.rollSkillTest,context:t,argsList:n},{fn:t?.rollSkillDicePool,context:t,argsList:n},{fn:t?.rollCheck,context:t,argsList:n}];if(await this.#_t(s))return!0;const r=game?.l5r5e??{},l=r?.HelpersL5r5e,a=this.#Tt(i,{skill:e,skillId:e}),o=[],c=[[t,e,this.#Tt(a)],[t,this.#Tt(a)],[this.#Tt(a)],[{actor:t,skill:e,options:this.#Tt(a)}]];l&&o.push({fn:l.rollSkill,context:l,argsList:c});const u=[r?.Rolls,r?.Roller,r?.Dice,r?.dice,r?.checks],d=["rollSkill","skill","skillCheck","rollCheck","rollSkillCheck"];for(const i of u)if(i)for(const n of d){const s=i?.[n];"function"==typeof s&&o.push({fn:s,context:i,argsList:[[t,e,this.#Tt(a)],[t,this.#Tt(a)],[this.#Tt(a)],[{actor:t,skill:e,options:this.#Tt(a)}]]})}return this.#_t(o)}async#wt(t,e,i){if(!t||!e)return!1;const n=this.#jt(e,t,i),s=[{fn:t?.rollRing,context:t,argsList:n},{fn:t?.rollRingCheck,context:t,argsList:n},{fn:t?.rollRingTest,context:t,argsList:n},{fn:t?.rollRingDicePool,context:t,argsList:n},{fn:t?.rollCheck,context:t,argsList:n}];if(await this.#_t(s))return!0;const r=game?.l5r5e??{},l=r?.HelpersL5r5e,a=this.#Tt(i,{ring:e,ringId:e}),o=[[t,e,this.#Tt(a)],[t,e],[this.#Tt(a)],[{actor:t,ring:e,options:this.#Tt(a)}]],c=[];l&&c.push({fn:l.rollRing,context:l,argsList:o});const u=[r?.Rolls,r?.Roller,r?.Dice,r?.dice,r?.checks],d=["rollRing","ring","ringCheck","rollRingCheck","rollStance","stance"];for(const i of u)if(i)for(const n of d){const s=i?.[n];"function"==typeof s&&c.push({fn:s,context:i,argsList:[[t,e,this.#Tt(a)],[t,this.#Tt(a)],[this.#Tt(a)],[{actor:t,ring:e,options:this.#Tt(a)}]]})}return this.#_t(c)}async#Lt(t,e,i){if(!e)return!1;const n=this.#Rt(t,e,i),s=[{fn:e?.roll,context:e,argsList:n},{fn:e?.use,context:e,argsList:n},{fn:e?.attack,context:e,argsList:n},{fn:e?.execute,context:e,argsList:n},{fn:e?.activate,context:e,argsList:n},{fn:e?.perform,context:e,argsList:n},{fn:e?.trigger,context:e,argsList:n},{fn:e?.cast,context:e,argsList:n},{fn:e?.useItem,context:e,argsList:n}];if(await this.#_t(s))return!0;const r=[[e,this.#Tt(i,{item:e})],[e,this.#Tt(i,{item:e,actor:t})],[this.#Tt(i,{item:e})],[{actor:t,item:e,options:this.#Tt(i,{item:e})}],[e]],l=[{fn:t?.rollItem,context:t,argsList:r},{fn:t?.useItem,context:t,argsList:r},{fn:t?.performTechnique,context:t,argsList:r},{fn:t?.executeTechnique,context:t,argsList:r},{fn:t?.activateItem,context:t,argsList:r},{fn:t?.rollWeapon,context:t,argsList:r},{fn:t?.rollAttack,context:t,argsList:r},{fn:t?.rollTechnique,context:t,argsList:r},{fn:t?.useTechnique,context:t,argsList:r}];if(await this.#_t(l))return!0;const a=game?.l5r5e??{},o=a?.HelpersL5r5e,c=this.#Tt(i,{item:e}),u=[],d=[[t,e,this.#Tt(c)],[e,this.#Tt(c)],[this.#Tt(c)],[{actor:t,item:e,options:this.#Tt(c)}]];o&&(u.push({fn:o.rollItem,context:o,argsList:d}),u.push({fn:o.rollTechnique,context:o,argsList:d}),u.push({fn:o.rollWeapon,context:o,argsList:d}));const p=[a?.Rolls,a?.Roller,a?.Dice,a?.dice,a?.checks],f=["item","rollItem","useItem","technique","rollTechnique","weapon","rollWeapon","attack","rollAttack"];for(const i of p)if(i)for(const n of f){const s=i?.[n];"function"==typeof s&&u.push({fn:s,context:i,argsList:[[t,e,this.#Tt(c)],[e,this.#Tt(c)],[this.#Tt(c)],[{actor:t,item:e,options:this.#Tt(c)}]]})}return this.#_t(u)}#Pt(t,e,i){const n=this.#Tt(i,{skill:i.skill??t,skillId:i.skillId??t,skillKey:i.skillKey??t}),s=this.#Tt(n,{actor:n.actor??e});return[[t,this.#Tt(n)],[t,this.#Tt(s)],[this.#Tt(n)],[this.#Tt(s)],[{actor:e,skill:t,options:this.#Tt(n)}],[t],[]]}#jt(t,e,i){const n=this.#Tt(i,{ring:i.ring??t,ringId:i.ringId??t,ringKey:i.ringKey??t}),s=this.#Tt(n,{actor:n.actor??e});return[[t,this.#Tt(n)],[t,this.#Tt(s)],[this.#Tt(n)],[this.#Tt(s)],[{actor:e,ring:t,options:this.#Tt(n)}],[t],[]]}#Rt(t,e,i){const n=this.#Tt(i,{item:i.item??e,itemId:i.itemId??e?.id,sourceId:i.sourceId??e?.id,itemType:i.itemType??e?.type}),s=this.#Tt(n,{actor:n.actor??t});return[[this.#Tt(n)],[this.#Tt(s)],[e,this.#Tt(n)],[e,this.#Tt(s)],[t,e,this.#Tt(n)],[e],[]]}async#_t(t=[]){for(const e of t){if(!e)continue;const t=e.fn;if("function"!=typeof t)continue;const i=e.context??null,n=Array.isArray(e.argsList)&&e.argsList.length>0?e.argsList:[[]];for(const s of n){const n=Array.isArray(s)?s:[s];try{const s=await t.apply(i,n);if(e.validateResult){if(e.validateResult(s))return!0}else if(!1!==s)return!0}catch(t){continue}}}return!1}#Tt(t,e={}){return{...t??{},...e??{}}}#Ot(t){if(null==t)return null;if("number"==typeof t)return Number.isNaN(t)?null:t;if("string"==typeof t){const e=Number(t);return Number.isNaN(e)?null:e}if("object"==typeof t){const e=["value","current","count","amount","number","total"];for(const i of e){if(!Object.hasOwn(t,i))continue;const e=this.#Ot(t[i]);if(null!==e)return e}}return null}#$t(){const t=[game?.l5r5e?.DicePickerDialog,game?.l5r5e?.DicePicker,game?.l5r5e?.DicePoolDialog,game?.l5r5e?.Dice?.DicePickerDialog,game?.l5r5e?.Dice?.DicePoolDialog,game?.l5r5e?.apps?.DicePickerDialog,game?.l5r5e?.apps?.DicePoolDialog,game?.l5r5e?.apps?.dice?.DicePickerDialog,game?.l5r5e?.apps?.dice?.DicePoolDialog,game?.l5r5e?.applications?.DicePickerDialog,game?.l5r5e?.applications?.DicePoolDialog,CONFIG?.l5r5e?.DicePickerDialog,CONFIG?.l5r5e?.DicePoolDialog,CONFIG?.l5r5e?.applications?.DicePickerDialog,CONFIG?.l5r5e?.applications?.DicePoolDialog,CONFIG?.l5r5e?.applications?.dice?.DicePickerDialog,CONFIG?.l5r5e?.applications?.dice?.DicePoolDialog];for(const e of t){const t=this.#Et(e);if(t)return t}return null}#Et(t){if(!t)return null;if("function"==typeof t)return t;if("object"==typeof t){const e=["DicePickerDialog","DicePoolDialog","default","Dialog","Application"];for(const i of e)if("function"==typeof t[i])return t[i]}return null}#xt(t){if(t)if(t instanceof Set)for(const e of t){const t=this.#xt(e);if(t)return t}else if(t instanceof Map)for(const e of t.values()){const t=this.#xt(e);if(t)return t}else{if("string"==typeof t)return t;if("number"==typeof t)return String(t);if(Array.isArray(t))for(const e of t){const t=this.#xt(e);if(t)return t}else if("object"==typeof t){const e=["ring","id","key","value","default","defaultRing"];for(const i of e)if(t[i]){const e=this.#xt(t[i]);if(e)return e}}}}#St(t){if(!t)return[];if(t instanceof Set)return this.#Dt([...t].flatMap((t=>this.#St(t))));if(t instanceof Map)return this.#Dt([...t.values()].flatMap((t=>this.#St(t))));if(Array.isArray(t))return this.#Dt(t.flatMap((t=>this.#St(t))));if("string"==typeof t)return[t];if("number"==typeof t)return[String(t)];if("object"==typeof t){const e=["id","ids","skill","skills","skillId","skillIds","skill_ids","skillList","skillsList","value","values","default","primary","entry","entries","list","items"];for(const i of e)if(t[i])return this.#St(t[i]);return this.#Dt(Object.values(t).flatMap((t=>this.#St(t))))}return[]}#Dt(t){return[...new Set(t.map((t=>null==t?"":String(t))).filter((t=>t)))]}async#vt(t,e){if("endTurn"===e)game.combat?.current?.tokenId===t.id&&await(game.combat?.nextTurn())}}}function register(e){game.settings.register(t.ID,"displayUnequipped",{name:game.i18n.localize("tokenActionHud.l5r5e.settings.displayUnequipped.name"),hint:game.i18n.localize("tokenActionHud.l5r5e.settings.displayUnequipped.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}function createSystemManagerClass(t){const e=createActionHandlerClass(t),i=createRollHandlerClass(t);return class SystemManager extends t.SystemManager{getActionHandler(){return new e}getAvailableRollHandlers(){return{core:"Core Template"}}getRollHandler(t){let e;return e=new i,e}async registerDefaults(){return g}registerSettings(t){register(t)}}}Hooks.once("tokenActionHudCoreApiReady",(async t=>{const e=s,i=getTechniqueTypeEntries();i.forEach((t=>{e[t.id]?e[t.id].name||(e[t.id].name=t.translationKey??t.label??t.id):e[t.id]={id:t.id,name:t.translationKey??t.label??t.id,type:"system"}})),Object.values(e).forEach((e=>{e.name=t.api.Utils.i18n(e.name),e.listName=`Group: ${t.api.Utils.i18n(e.listName??e.name)}`}));const n=Object.values(e),r=i.map((t=>({...e[t.id],nestId:`techniques_${String(t.actorKey??t.id).replace(/[^a-zA-Z0-9]+/g,"_")}`})));g={layout:[{nestId:"inventory",id:"inventory",name:t.api.Utils.i18n("l5r5e.sheets.inventory"),groups:[{...e.weapons,nestId:"inventory_weapons"},{...e.armor,nestId:"inventory_armor"},{...e.equipment,nestId:"inventory_items"}]},{nestId:"attributes",id:"attributes",name:t.api.Utils.i18n("l5r5e.attributes.title"),groups:[{...e.rings,nestId:"attributes_rings"},{...e.derived,nestId:"attributes_derived"},{...e.standing,nestId:"attributes_standing"}]},{nestId:"skills",id:"skills",name:t.api.Utils.i18n("l5r5e.skills.title"),groups:[{...e.artisan,nestId:"skills_artisan"},{...e.martial,nestId:"skills_martial"},{...e.scholar,nestId:"skills_scholar"},{...e.social,nestId:"skills_social"},{...e.trade,nestId:"skills_trade"}]},{nestId:"techniques",id:"techniques",name:t.api.Utils.i18n("l5r5e.techniques.title"),groups:r},{nestId:"utility",id:"utility",name:t.api.Utils.i18n("tokenActionHud.utility"),groups:[{...e.combat,nestId:"utility_combat"},{...e.token,nestId:"utility_token"},{...e.rests,nestId:"utility_rests"},{...e.utility,nestId:"utility_utility"}]}],groups:n}})),Hooks.once("tokenActionHudCoreApiReady",(e=>{try{if("function"!=typeof e.registerSystem)return void console.error("Token Action HUD Core API does not provide registerSystem. Please update Token Action HUD Core to version 2.x.");const i=createSystemManagerClass(e);e.registerSystem({moduleId:t.ID,requiredCoreModuleVersion:"2.0.12",SystemManager:i})}catch(t){console.error("Failed to register Token Action HUD L5R5E system with Token Action HUD Core.",t)}}));let y=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{y=class Utils{static getSetting(i,n=null){let s=n??null;try{s=game.settings.get(t.ID,i)}catch{e.api.Logger.debug(`Setting '${i}' not found`)}return s}static async setSetting(i,n){try{n=await game.settings.set(t.ID,i,n),e.api.Logger.debug(`Setting '${i}' set to '${n}'`)}catch{e.api.Logger.debug(`Setting '${i}' not found`)}}}}));export{n as ACTION_TYPE,e as CORE_MODULE,g as DEFAULTS,s as GROUP,u as ITEM_BONUS,o as ITEM_PATTERN,a as ITEM_QUALITIES,c as ITEM_TAGS,r as ITEM_TYPE,t as MODULE,i as REQUIRED_CORE_MODULE_VERSION,l as SKILL_TYPE,y as Utils,createActionHandlerClass,createRollHandlerClass,createSystemManagerClass,getActorSection,getAttributeEntries,getCoreApi,getCoreModule,getInventoryGroupEntries,getTechniqueTypeEntries,register,sanitizeId,unsanitizeId};
