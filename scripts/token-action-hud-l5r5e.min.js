const e={ID:"token-action-hud-l5r5e"},t={ID:"token-action-hud-core"},i="2.0.12",n={item:"tokenActionHud.template.item",utility:"tokenActionHud.utility",armor:"l5r5e.armors.title",equipped:"tokenActionHud.equipped",unequipped:"tokenActionHud.unequipped",equipment:"l5r5e.items.title",weapons:"l5r5e.weapons.title",technique:"l5r5e.techniques.title",ring:"l5r5e.rings.title",skill:"l5r5e.skills.title",derived:"l5r5e.attributes.title",standing:"l5r5e.social.title"},s={armor:{id:"armor",name:"l5r5e.armors.title",type:"system"},equipment:{id:"equipment",name:"l5r5e.items.title",type:"system"},equipped:{id:"equipped",name:"Equipped",type:"system"},unequipped:{id:"unequipped",name:"Unequipped",type:"system"},weapons:{id:"weapons",name:"l5r5e.weapons.title",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},rests:{id:"rests",name:"tokenActionHud.rests",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},rings:{id:"rings",name:"l5r5e.rings.title",type:"system"},derived:{id:"derived",name:"l5r5e.attributes.title",type:"system"},standing:{id:"standing",name:"l5r5e.social.title",type:"system"},artisan:{id:"artisan",name:"l5r5e.skills.artisan.title",type:"system"},martial:{id:"martial",name:"l5r5e.skills.martial.title",type:"system"},scholar:{id:"scholar",name:"l5r5e.skills.scholar.title",type:"system"},social:{id:"social",name:"l5r5e.skills.social.title",type:"system"},trade:{id:"trade",name:"l5r5e.skills.trade.title",type:"system"},kata:{id:"kata",name:"l5r5e.techniques.kata",type:"system"},kiho:{id:"kiho",name:"l5r5e.techniques.kiho",type:"system"},inversion:{id:"inversion",name:"l5r5e.techniques.inversion",type:"system"},invocation:{id:"invocation",name:"l5r5e.techniques.invocation",type:"system"},ritual:{id:"ritual",name:"l5r5e.techniques.ritual",type:"system"},shuji:{id:"shuji",name:"l5r5e.techniques.shuji",type:"system"},maho:{id:"maho",name:"l5r5e.techniques.maho",type:"system"},ninjutsu:{id:"ninjutsu",name:"l5r5e.techniques.ninjutsu",type:"system"},mantra:{id:"mantra",name:"l5r5e.techniques.mantra",type:"system"},school_ability:{id:"school-ability",name:"l5r5e.techniques.school_ability",type:"system"},mastery_ability:{id:"mastery-ability",name:"l5r5e.techniques.mastery_ability",type:"system"},title_ability:{id:"title-ability",name:"l5r5e.techniques.title_ability",type:"system"}},r={armor:{groupId:"armor"},equipment:{groupId:"equipment"},weapon:{groupId:"weapons"}},l={artisan:{groupId:"artisan"},martial:{groupId:"martial"},scholar:{groupId:"scholar"},social:{groupId:"social"},trade:{groupId:"trade"}},a={razor_edged:"tokenActionHud.l5r5e.qualities.razorEdged",ceremonial:"tokenActionHud.l5r5e.qualities.ceremonial",damaged:"tokenActionHud.l5r5e.qualities.damaged",destroyed:"tokenActionHud.l5r5e.qualities.destroyed",concealable:"tokenActionHud.l5r5e.qualities.concealable",cumbersome:"tokenActionHud.l5r5e.qualities.cumbersome",snaring:"tokenActionHud.l5r5e.qualities.snaring",unholy:"tokenActionHud.l5r5e.qualities.unholy",forbidden:"tokenActionHud.l5r5e.qualities.forbidden",resplendent:"tokenActionHud.l5r5e.qualities.resplendent",wargear:"tokenActionHud.l5r5e.qualities.wargear",mundane:"tokenActionHud.l5r5e.qualities.mundane",prepare:"tokenActionHud.l5r5e.qualities.prepare",sacred:"tokenActionHud.l5r5e.qualities.sacred",durable:"tokenActionHud.l5r5e.qualities.durable",subtle:"tokenActionHud.l5r5e.qualities.subtle",kenzo_blade:"tokenActionHud.l5r5e.qualities.kenzoBlade"},o={jade_inlay:"tokenActionHud.l5r5e.patterns.jadeInlay",uchema:"tokenActionHud.l5r5e.patterns.uchema",yasunori:"tokenActionHud.l5r5e.patterns.yasunori",akodo:"tokenActionHud.l5r5e.patterns.akodo",burning_water:"tokenActionHud.l5r5e.patterns.burningWater",concealment:"tokenActionHud.l5r5e.patterns.concealment",deadly_fangs:"tokenActionHud.l5r5e.patterns.deadlyFangs",fearsome_snarl:"tokenActionHud.l5r5e.patterns.fearsomeSnarl",ichiro:"tokenActionHud.l5r5e.patterns.ichiro",mountain_silk:"tokenActionHud.l5r5e.patterns.mountainSilk",screaming_fire:"tokenActionHud.l5r5e.patterns.screamingFire",toriyama:"tokenActionHud.l5r5e.patterns.toriyama",qamarist:"tokenActionHud.l5r5e.patterns.qamarist",yodhaniya:"tokenActionHud.l5r5e.patterns.yodhaniya",kokejin:"tokenActionHud.l5r5e.patterns.kokejin",agasha:"tokenActionHud.l5r5e.patterns.agasha"},c={default:{icon:"fa-solid fa-tag",class:"tah-tag-secondary"},pattern:{icon:"fa-solid fa-swatchbook",class:"tah-tag-tertiary"},bonus:{icon:"fa-solid fa-arrow-up-right-dots",class:"tah-tag-alt"},clan:{label:"tokenActionHud.l5r5e.tags.clan",icon:"fa-solid fa-flag",class:"tah-tag-secondary"},culture:{label:"tokenActionHud.l5r5e.tags.culture",icon:"fa-solid fa-earth-asia",class:"tah-tag-secondary"},material:{label:"tokenActionHud.l5r5e.tags.material",icon:"fa-solid fa-gem",class:"tah-tag-secondary"},tradition:{label:"tokenActionHud.l5r5e.tags.tradition",icon:"fa-solid fa-scroll",class:"tah-tag-secondary"}},u={armorTN:{label:"tokenActionHud.l5r5e.bonuses.armorTN",icon:"fa-solid fa-shield-halved",class:"tah-tag-alt"},resistance:{label:"tokenActionHud.l5r5e.bonuses.resistance",icon:"fa-solid fa-shield",class:"tah-tag-alt"},fatigue:{label:"tokenActionHud.l5r5e.bonuses.fatigue",icon:"fa-solid fa-heart-pulse",class:"tah-tag-alt"},strife:{label:"tokenActionHud.l5r5e.bonuses.strife",icon:"fa-solid fa-fire",class:"tah-tag-alt"},deadliness:{label:"tokenActionHud.l5r5e.bonuses.deadliness",icon:"fa-solid fa-skull",class:"tah-tag-alt"},damage:{label:"tokenActionHud.l5r5e.bonuses.damage",icon:"fa-solid fa-burst",class:"tah-tag-alt"},opportunities:{label:"tokenActionHud.l5r5e.bonuses.opportunities",icon:"fa-solid fa-dice-d20",class:"tah-tag-alt"}},d=[{id:"kata",actorKey:"kata",translationKey:"l5r5e.techniques.kata"},{id:"kiho",actorKey:"kiho",translationKey:"l5r5e.techniques.kiho"},{id:"inversion",actorKey:"inversion",translationKey:"l5r5e.techniques.inversion"},{id:"invocation",actorKey:"invocation",translationKey:"l5r5e.techniques.invocation"},{id:"ritual",actorKey:"ritual",translationKey:"l5r5e.techniques.ritual"},{id:"shuji",actorKey:"shuji",translationKey:"l5r5e.techniques.shuji"},{id:"maho",actorKey:"maho",translationKey:"l5r5e.techniques.maho"},{id:"ninjutsu",actorKey:"ninjutsu",translationKey:"l5r5e.techniques.ninjutsu"},{id:"mantra",actorKey:"mantra",translationKey:"l5r5e.techniques.mantra"},{id:"school-ability",actorKey:"school_ability",translationKey:"l5r5e.techniques.school_ability"},{id:"mastery-ability",actorKey:"mastery_ability",translationKey:"l5r5e.techniques.mastery_ability"},{id:"title-ability",actorKey:"title_ability",translationKey:"l5r5e.techniques.title_ability"}],p=[{id:"armor",actorKey:"armor",translationKey:"l5r5e.armors.title"},{id:"equipment",actorKey:"equipment",translationKey:"l5r5e.items.title"},{id:"weapons",actorKey:"weapons",translationKey:"l5r5e.weapons.title"}],f=[{id:"air",translationKey:"l5r5e.rings.air"},{id:"earth",translationKey:"l5r5e.rings.earth"},{id:"fire",translationKey:"l5r5e.rings.fire"},{id:"water",translationKey:"l5r5e.rings.water"},{id:"void",translationKey:"l5r5e.rings.void"}],y={derived:{helperMethods:["getDerivedAttributesList","getDerivedList","getDerivedAttributes"],helperArgsSets:e=>[[e],[]],configPaths:["derivedAttributes","derived","attributes.derived"],actorPaths:["derived","attributes.derived"],translationPrefix:"l5r5e.attributes"},standing:{helperMethods:["getStandingAttributesList","getStandingList","getSocialAttributesList","getSocialAttributes"],helperArgsSets:e=>[[e],[]],configPaths:["standingAttributes","standing","social","attributes.social"],actorPaths:["standing","social","attributes.standing","attributes.social"],translationPrefix:"l5r5e.social"}};function sanitizeId(e){if(null==e)return"";return String(e).trim().replace(/\s+/g,"-").replace(/_/g,"-").toLowerCase()}function unsanitizeId(e){if(null==e)return"";return String(e).trim().replace(/\s+/g,"_").replace(/-/g,"_")}function getTechniqueTypeEntries(){return dedupeEntries(collectEntries({helperMethods:["getTechniqueTypesList","getTechniqueTypes","getTechniquesTypesList","getTechniquesList"],configPaths:["techniqueTypes","technique_types","techniques.types","techniques.categories","techniques.type"],translationPrefix:"l5r5e.techniques",stringIsTranslation:!0,fallback:d}))}function getInventoryGroupEntries(){return dedupeEntries(collectEntries({helperMethods:["getInventoryGroupIds","getInventoryCategoriesList","getInventorySections"],configPaths:["inventory.groups","inventory.categories","inventoryCategories","itemGroups.inventory","items.inventory"],translationPrefix:null,stringIsTranslation:!0,fallback:p}))}function getRingEntries(e){const t=getHelpers(),i=["getRingsList","getRings","getRingList","getRingEntries","ringsList","rings"],n=e?[[e],[e,{actor:e}],[{actor:e}],[]]:[[{actor:e}],[]];for(const s of i){const i=t?.[s],r=invokeAndNormalizeRingEntries(i,t,n,e);if(r.length>0)return r}const s=["rings.list","rings.entries","rings","attributes.rings","characteristics.rings"];for(const t of s){const i=normalizeRingEntries(foundry.utils.getProperty(CONFIG?.l5r5e??{},t),e);if(i.length>0)return i}const r=normalizeRingEntries(e?.system?.rings,e);return r.length>0?r:normalizeRingEntries(f,e)}function getAttributeEntries(e,t){const i=y[e];if(!i)return{entries:[],section:null};const n="function"==typeof i.helperArgsSets?i.helperArgsSets(t):i.helperArgsSets??[[]],s=collectEntries({helperMethods:i.helperMethods,helperArgsSets:n,configPaths:i.configPaths,translationPrefix:i.translationPrefix,stringIsTranslation:!0,fallback:[]}),r=getActorSection(t,i.actorPaths);if(s.length>0)return{entries:dedupeEntries(s),section:r};if(!r)return{entries:[],section:null};return{entries:dedupeEntries(Object.keys(r).map((e=>{const t=e;return{id:sanitizeId(t),actorKey:t,translationKey:i.translationPrefix?buildTranslationKey(i.translationPrefix,t):null}}))),section:r}}function getActorSection(e,t=[]){if(!e)return null;const i=e.system??{};for(const e of t){const t=foundry.utils.getProperty(i,e);if(t)return t}return null}function collectEntries({helperMethods:e=[],helperArgsSets:t=[[]],configPaths:i=[],translationPrefix:n=null,stringIsTranslation:s=!1,fallback:r=[]}){const l=function getEntriesFromHelpers(e,t,i,n){const s=getHelpers();if(!s)return[];for(const r of e){const e=s?.[r];if("function"==typeof e)for(const l of t)try{const t=normalizeEntries(Array.isArray(l)?e.apply(s,l):e.call(s,l),{translationPrefix:i,stringIsTranslation:n});if(t.length>0)return t}catch(e){console.debug(`Token Action HUD L5R5e | Helper ${r} failed`,e)}}return[]}(e,t,n,s);if(l.length>0)return l;const a=function getEntriesFromConfig(e,t,i){const n=CONFIG?.l5r5e;if(!n)return[];for(const s of e){const e=normalizeEntries(foundry.utils.getProperty(n,s),{translationPrefix:t,stringIsTranslation:i});if(e.length>0)return e}return[]}(i,n,s);return a.length>0?a:r}function normalizeEntries(e,t={}){if(!e)return[];if(e instanceof Map)return[...e.entries()].map((([e,i])=>normalizeEntry(i,e,t))).filter(Boolean);if(Array.isArray(e))return e.map(((e,i)=>normalizeEntry(e,e?.id??e?.key??e?.type??e?.slug??e??i,t))).filter(Boolean);if("object"==typeof e)return Object.entries(e).map((([e,i])=>normalizeEntry(i,e,t))).filter(Boolean);if("string"==typeof e){const i=normalizeEntry(e,e,t);return i?[i]:[]}return[]}function normalizeEntry(e,t,{translationPrefix:i,stringIsTranslation:n}={}){if(null==e)return null;let s,r,l,a;if("object"!=typeof e||Array.isArray(e)?"string"==typeof e?(s=t??e,n&&e.includes(".")?r=e:t||(s=e),!r&&!l&&n&&e.includes(".")&&(r=e),l||n||(l=e)):s=t:(s=e.id??e.key??e.type??e.slug??e.value??e.name??t,r=e.translationKey??e.labelKey??e.i18n??null,l=e.label??e.name??e.title??e.display??e.text??null,a=e.path??e.dataPath??null),!s&&0!==s)return null;const o="string"==typeof s?s:String(s),c=sanitizeId(o);return!r&&i&&(r=buildTranslationKey(i,o)),{id:c,actorKey:o,translationKey:r,label:l,path:a}}function buildTranslationKey(e,t){if(!e||null==t)return null;return`${e}.${String(t).replace(/\s+/g,"_").replace(/-/g,"_").toLowerCase()}`}function dedupeEntries(e){const t=new Map;for(const i of e)i?.id&&(t.has(i.id)||t.set(i.id,i));return[...t.values()]}function invokeAndNormalizeRingEntries(e,t,i,n){if("function"!=typeof e)return[];for(const s of i)try{const i=normalizeRingEntries(Array.isArray(s)?e.apply(t,s):e.call(t,s),n);if(i.length>0)return i}catch(e){console.debug("Token Action HUD L5R5e | Ring helper failed",e)}return[]}function normalizeRingEntries(e,t){const i=[],pushEntry=(e,n)=>{if(!e&&void 0===n)return;const s=sanitizeId(e?.id??e?.key??e?.slug??e?.value??e?.name??n);if(!s)return;const r=e?.label??e?.name??e?.title??e?.translationKey??null,l=e?.translationKey??buildTranslationKey("l5r5e.rings",s),a=function resolveRingValue(e,t,i){const n=extractRingValue(e);if(""!==n&&null!=n)return n;const s=extractRingValue(i?.system?.rings?.[t]??i?.system?.rings?.[unsanitizeId(t)]);return""!==s&&null!=s?s:""}(e,s,t);i.push({id:s,label:r,translationKey:l,value:a})};return e?e instanceof Map?(e.forEach(((e,t)=>{pushEntry("object"==typeof e?e:{value:e},t)})),i):Array.isArray(e)?(e.forEach(((e,t)=>{"object"==typeof e?pushEntry(e,e?.id??e?.key??e?.slug??t):pushEntry({id:e},e)})),i):"object"==typeof e?(Object.entries(e).forEach((([e,t])=>{pushEntry("object"==typeof t?{id:t.id??e,...t}:{id:e,value:t},e)})),i):("string"==typeof e&&pushEntry({id:e},e),i):i}function extractRingValue(e){if(null==e)return"";if("number"==typeof e||"string"==typeof e)return e;if("object"!=typeof e)return"";for(const t of["value","rank","rating","level","dice","current","score"])if(void 0!==e[t])return e[t];const t=Object.values(e).filter((e=>"number"==typeof e));return 1===t.length?t[0]:t.length>1?t.join("/"):""}function getHelpers(){const e=game?.l5r5e??{};return e.HelpersL5r5e??e.helpers??e?.apps?.helpers??e?.applications?.helpers??e?.api?.helpers??e?.Helpers??null}function createActionHandlerClass(e){return class ActionHandler extends e.ActionHandler{async buildSystemActions(t){if(this.actors=this.actor?[this.actor]:this.#e(),this.tokens=this.token?[this.token]:this.#t(),this.actorType=this.actor?.type,this.displayUnequipped=Utils.getSetting("displayUnequipped"),this.actor){let t=this.actor.items;t=e.Utils.sortItemsByName(t),this.items=t,this.inventoryGroups=this.#i(getInventoryGroupEntries());const i=getTechniqueTypeEntries();this.techniqueGroups=this.#i(i),this.techniqueTypeKeys=new Set(i.flatMap((e=>[e.actorKey??e.id,e.id])))}"character"===this.actorType||"npc"===this.actorType?await this.#n():this.actor||this.#s()}async#n(){await Promise.all([this.#r(),this.#l()]),this.#a(),this.#o(),this.#c(),this.#u()}#s(){if(0===(Array.isArray(this.tokens)?this.tokens:[]).length)return;const t=Array.isArray(this.actors)?this.actors.filter((e=>!!e)):[],i=[],n=e.Utils.i18n?.("tokenActionHud.utility")??game.i18n.localize?.("tokenActionHud.utility")??"Utility",s=e.Utils.i18n?.("tokenActionHud.utility.endTurn")??game.i18n.localize?.("tokenActionHud.utility.endTurn")??"End Turn";if(i.push({id:"endTurn",name:s,encodedValue:["utility","endTurn"].join(this.delimiter),listName:`${n}: ${s}`}),i.length>0){const e={id:"utility",name:n,type:"system"};this.addActions(i,e)}if(0===t.length)return;const r=t[0];if(!r)return;const l=getRingEntries(r);if(0===l.length)return;const a=new Set(t.map((e=>e?.system?.stance)).filter((e=>"string"==typeof e))),o=l.map((i=>{try{const n=i.id;if(!n)return null;const s=["ring",n].join(this.delimiter),r=i.translationKey??`l5r5e.rings.${n}`,l=r?e.Utils.i18n?.(r):null,o=l&&l!==r?l:e.Utils.i18n?.(`l5r5e.rings.${n}`)??i.label??n,c=t.map((e=>this.#d(e,n))).filter((e=>null!=e&&""!==e));let u=o;if(c.length===t.length&&c.length>0){const e=[...new Set(c)];u=1===e.length?`${o}: ${e[0]}`:`${o}: ${e.join("/")}`}else null!=i?.value&&""!==i?.value&&(u=`${o}: ${i.value}`);let d="";1===a.size&&a.has(n)&&(d="toggle active");const p=`l5r5e.conflict.stances.${n}tip`,f=e.Utils.i18n?.(p),y=f&&f!==p?f:"",g=e.Utils.getImage?.(`systems/l5r5e/assets/icons/rings/${n}.svg`),m=c.length?c.join("/"):"";return{id:n,name:u,img:g,encodedValue:s,cssClass:d,tooltip:y,listName:m?`${o}: ${m}`:o}}catch(t){return e.Logger?.error?.(t),null}})).filter((e=>!!e));if(0===o.length)return;const c={id:"rings",name:e.Utils.i18n?.("l5r5e.rings.title")??"rings",type:"system"};this.addActions(o,c)}async#r(){const e=this.#p(this.items);if(0===e.length)return;const t=new Map;for(const[i,n]of e){const e=this.#f(n),s=null===e||e>0,r=this.#y(n),l=this.#g(n),a=n.type;s&&(l&&(t.has("equipped")||t.set("equipped",new Map),t.get("equipped").set(i,n)),l||(t.has("unequipped")||t.set("unequipped",new Map),t.get("unequipped").set(i,n)),r&&("item"===a&&(t.has("equipment")||t.set("equipment",new Map),t.get("equipment").set(i,n)),"weapon"===a&&(t.has("weapons")||t.set("weapons",new Map),t.get("weapons").set(i,n)),"armor"===a&&(t.has("armor")||t.set("armor",new Map),t.get("armor").set(i,n))))}const i=this.inventoryGroups?[...this.inventoryGroups.keys()]:[],n=[...t.keys()],s=[...new Set([...i,...n])];for(const e of s){const i=t.get(e);if(!i||0===i.size)continue;const n=this.#m(e,this.inventoryGroups);await this.#h(i,n,e)}}#a(){const t="ring",i=getRingEntries(this.actor);if(!i||0===i.length)return;const n=this.actor?.system?.stance,s={id:"rings",name:`${e.Utils.i18n("l5r5e.rings.title")}`??"rings",type:"system"},r=i.map((i=>{try{const s=i.id;if(!s)return null;const r=[t,s].join(this.delimiter),l=i.translationKey??`l5r5e.rings.${s}`,a=l?e.Utils.i18n?.(l):null,o=a&&a!==l?a:e.Utils.i18n?.(`l5r5e.rings.${s}`)??i.label??s,c=i?.value??this.#d(this.actor,s),u=null!=c&&""!==c,d=u?`${o}: ${c}`:o,p=e.Utils.i18n?.("l5r5e.rings.title"),f=p&&"l5r5e.rings.title"!==p?`${p}: ${d}`:d,y=e.Utils.getImage(`systems/l5r5e/assets/icons/rings/${s}.svg`),g=`l5r5e.conflict.stances.${s}tip`,m=e.Utils.i18n?.(g);let h="";s===n&&(h="toggle active");const k={id:s,name:d,img:y,encodedValue:r,cssClass:h,tooltip:m&&m!==g?m:"",listName:f};return u&&(k.info1={text:c}),k}catch(t){return e.Logger.error(i),null}})).filter((e=>!!e));this.addActions(r,s)}#u(){if(!["character","npc"].includes(this.actorType))return;const t="skill",i=this.#k();for(const n of i){const i=n.id;try{const s={id:i,name:n.label,type:"system"},r=n.skills.map((s=>{const r=[t,s].join(this.delimiter),l=this.#b(i,s),a=n.skillLabels instanceof Map?n.skillLabels.get(s)??n.skillLabels.get(String(s)):n.skillLabels?.[s]??n.skillLabels?.[String(s)],o=this.#A(i,s,a),c=""!==l&&null!=l?`${o}: ${l}`:o;return{id:s,name:c,encodedValue:r,listName:`${`${e.Utils.i18n("l5r5e.skills.label")}: `??""}${c}`}}));this.addActions(r,s)}catch(t){return e.Logger.error(i),null}}}#k(){const e=game.l5r5e?.HelpersL5r5e??{},t="npc"===this.actorType?this.#v(e,!0):this.#v(e,!1);return this.#I(t).map((e=>{if(!e||!e.id||!e.skills||0===e.skills.length)return null;const t=this.#S(e.id,e.label);return{id:e.id,label:t,skills:e.skills,skillLabels:e.skillLabels}})).filter((e=>e&&e.skills.length>0))}#I(e){if(!e)return[];const t=[],addEntry=(e,i)=>{const n=this.#q(e,i);n&&n.id&&t.push(n)};if(e instanceof Map){for(const[t,i]of e.entries())addEntry(i,t);return t}return Array.isArray(e)?(e.forEach(((e,t)=>addEntry(e,t))),t):"object"==typeof e?(Object.entries(e).forEach((([e,t])=>addEntry(t,e))),t):[]}#q(e,t){if(null==e)return null;const i="string"==typeof t||"number"==typeof t?String(t):void 0;if(Array.isArray(e)&&e.length>0){if(e.length>=2){const[t,n,s]=e,{ids:r,labels:l}=this.#C(n);return{id:"string"==typeof t||"number"==typeof t?String(t):i,label:"string"==typeof s?s:e.label??e.name??null,skills:r,skillLabels:l}}const{ids:t,labels:n}=this.#C(e);return{id:i,label:e.label??e.name??null,skills:t,skillLabels:n}}if(e instanceof Set||e instanceof Map){const{ids:t,labels:n}=this.#C(e);return{id:i,label:e.label??e.name??e.title??null,skills:t,skillLabels:n}}if("object"==typeof e){const t="string"==typeof e.id||"number"==typeof e.id?String(e.id):"string"==typeof e.key||"number"==typeof e.key?String(e.key):"string"==typeof e.category||"number"==typeof e.category?String(e.category):"string"==typeof e.type||"number"==typeof e.type?String(e.type):i,n=e.label??e.name??e.title??e.categoryLabel??e.categoryName??null,s=e.skills??e.skillIds??e.skill_ids??e.skillList??e.skill_list??e.skillGroups??e.skill_groups??e.values??e.entries??e.list??e.items??e.data??e.set??e.group,{ids:r,labels:l}=this.#C(s??e);return{id:t,label:n,skills:r,skillLabels:l}}if("string"==typeof e||"number"==typeof e){const{ids:t,labels:n}=this.#C([e]);return{id:i??(1===t.length?t[0]:String(e)),label:null,skills:t,skillLabels:n}}return null}#C(e){const t=[],i=new Map,addSkill=(e,n)=>{if(null==e)return;const s=String(e);s&&(t.push(s),n&&!i.has(s)&&i.set(s,String(n)))},visit=(e,t)=>{if(null!=e)if(e instanceof Set)e.forEach((e=>visit(e)));else if(e instanceof Map)for(const[t,i]of e.entries())if("object"==typeof i&&null!==i){const e=i.id??i.key??i.skill??i.slug??i.value??t,n=i.label??i.name??i.title??null;void 0!==e&&addSkill(e,n),visit(i.skills??i.skill??i.values??i.entries??i.list??i.items,null)}else visit(i,t);else if(Array.isArray(e))e.forEach((e=>{if(Array.isArray(e))visit(e);else if("object"==typeof e&&null!==e){const i=e.id??e.key??e.skill??e.slug??e.value??e.default??e.primary??t,n=e.label??e.name??e.title??e.displayName??null;void 0!==i&&addSkill(i,n);const s=e.skills??e.skill??e.values??e.entries??e.list??e.items;s&&visit(s)}else visit(e)}));else if("object"!=typeof e)"string"!=typeof e&&"number"!=typeof e||addSkill(e);else{const i=e.id??e.key??e.skill??e.slug??e.value??e.default??e.primary??t,n=e.label??e.name??e.title??e.displayName??null;void 0!==i&&addSkill(i,n);const s=["skill","skills","ids","id","keys","key","values","value","default","primary","entries","list","items","options","choices"];for(const t of s)void 0!==e[t]&&visit(e[t])}};return visit(e),{ids:this.#w(t),labels:i}}#x(e){return e?e instanceof Map?this.#w([...e.values()]):Array.isArray(e)?this.#w(e.flatMap((e=>this.#x(e)))):"string"==typeof e?this.#w([e]):"object"==typeof e?e.id?this.#x(e.id):e.key?this.#x(e.key):e.value?this.#x(e.value):e.default?this.#x(e.default):e.skills?this.#x(e.skills):e.entries?this.#x(e.entries):e.list?this.#x(e.list):e.items?this.#x(e.items):this.#w(Object.values(e).flatMap((e=>this.#x(e)))):[]:[]}#w(e){return[...new Set(e.map((e=>null==e?"":String(e))).filter((e=>e)))]}#S(e,t){if(t)return t;const i=game.l5r5e?.HelpersL5r5e,n=["getSkillCategoryLabel","getNpcSkillCategoryLabel"];for(const t of n){const n=i?.[t];if("function"==typeof n)try{const t=n.call(i,e,this.actor);if(t)return t}catch(e){continue}}const s=CONFIG?.l5r5e??{},r=s?.npc?.skills?.[e]??s?.skills?.[e];if(r){const e=r.label??r.name??r.title;if(e)return e}const l=[`l5r5e.npc.skills.${e}.title`,`l5r5e.skills.${e}.title`,`l5r5e.skills.${e}`,e];return this.#H(l)}#A(e,t,i){if(i)return i;const n=game.l5r5e?.HelpersL5r5e,s=[["getNpcSkillLabel",[e,t]],["getNpcSkillLabel",[t]],["getSkillLabel",[e,t]],["getSkillLabel",[t]],["getSkillName",[t]],["getSkillNameFromId",[t]]];for(const[e,t]of s){const i=n?.[e];if("function"==typeof i)try{const e=i.apply(n,t);if(e)return e}catch(e){continue}}const r=CONFIG?.l5r5e??{},l=r?.npc?.skills?.[e]?.[t]??r?.skills?.[e]?.[t]??r?.skills?.[t];if(l){const e=l.label??l.name??l.title;if(e)return e}const a=[`l5r5e.npc.skills.${e}.${t}`,`l5r5e.skills.${e}.${t}`,`l5r5e.skills.${t}`,`l5r5e.skill.${t}`,t];return this.#H(a)}#b(e,t){const i=[this.actor?.system?.skills,this.actor?.system?.npcSkills,this.actor?.system?.npc?.skills,this.actor?.system?.npc?.skillCategories,this.actor?.system?.npc?.skill_categories,this.actor?.system?.npc?.skillGroups,this.actor?.system?.npc?.skill_groups,this.actor?.system?.skillRanks,this.actor?.system?.skillGroups,this.actor?.system?.skill_groups];for(const n of i){const i=n?.[e];if(!i)continue;const s=i?.[t],r=this.#D(s);if(null!=r)return r}const n=this.actor?.system?.skills?.[t],s=this.#D(n);return null!=s?s:""}#v(e,t=!1){const i=this.actor,n=t?["getNpcSkillCategoriesList","getNpcSkillCategories","getNpcSkillsCategoriesList","getNpcSkillsCategories","getNpcSkillsList","getNpcSkills","getNpcSkillGroupsList","getNpcSkillGroups"]:["getCategoriesSkillsList","getSkillCategoriesList","getSkillsCategoriesList","getSkillsList","getSkillCategories"],s=Object.keys(e??{}).filter((e=>{const i=e.toLowerCase();return!!i.includes("skill")&&(!(t&&!i.includes("npc"))&&(!(!t&&i.includes("npc"))&&(i.includes("list")||i.includes("categor")||i.includes("group"))))})),r=new Set,l=[...n,...s];for(const t of l){if(r.has(t))continue;r.add(t);const n=e?.[t],s=this.#T(n,e,i);if(s)return s}const a=t?["system.npc.skills","system.npcSkills","system.skills","system.npc.skillCategories","system.npc.skill_categories","system.npc.skillGroups","system.npc.skill_groups"]:["system.skills","system.skillCategories","system.skill_categories","system.skillGroups","system.skill_groups"];for(const e of a){const t=foundry.utils.getProperty(i,e);if(t)return t}return t?i?.system?.npcSkills??i?.system?.skills:i?.system?.skills}#T(e,t,i){if("function"!=typeof e)return null;const n=[[i],[i,{actor:i}],[]];for(const i of n)try{const n=e.apply(t,i);if(n)return n}catch(e){continue}return null}#D(e){if(null==e)return null;if("number"==typeof e||"string"==typeof e)return e;if("object"==typeof e)for(const t of["value","rank","dice","level","rating"])if(void 0!==e[t])return e[t];return null}#H(t){for(const i of t){if(!i)continue;const t=e.Utils.i18n(i);if(t&&t!==i)return t}return t[t.length-1]??""}async#l(e){if(0===this.items.size)return;const t=new Map;for(const[e,i]of this.items){if(this.#$(i)){const n=sanitizeId(i.system.technique_type);if(!n)continue;t.has(n)||t.set(n,new Map),t.get(n).set(e,i)}}const i=this.techniqueGroups?[...this.techniqueGroups.keys()]:[],n=[...t.keys()],s=[...new Set([...i,...n])];for(const e of s){const i=t.get(e);if(!i||0===i.size)continue;const n=this.#m(e,this.techniqueGroups,{fallbackPrefix:"l5r5e.techniques"});await this.#h(i,n,"technique")}}#e(){const t=["character","npc"],i=e.Utils.getControlledTokens()?.filter((e=>e.actor)).map((e=>e.actor));return i.every((e=>t.includes(e.type)))?i:[]}#t(){const t=["character","npc"],i=e.Utils.getControlledTokens(),n=i?.filter((e=>e.actor)).map((e=>e.actor));return n.every((e=>t.includes(e.type)))?i:[]}#y(e){const t=e.type;return!(!this.displayUnequipped||["item","technique","peculiarity"].includes(t))||this.#g(e)}#$(e){if("technique"!==e.type)return!1;if(!this.techniqueTypeKeys||0===this.techniqueTypeKeys.size)return!0;const t=e.system.technique_type;return!!t&&(this.techniqueTypeKeys.has(t)||this.techniqueTypeKeys.has(sanitizeId(t)))}#o(){this.#E("derived")}#c(){this.#E("standing")}#E(e){if(!this.actor)return;const{entries:t,section:i}=getAttributeEntries(e,this.actor);if(0===t.length)return;const n=t.map((t=>this.#L(t,i,e))).filter((e=>!!e));if(0===n.length)return;const s=this.#_(e);this.addActions(n,s)}#L(t,i,r){const l=this.#U(i,t,r);if(void 0===l)return null;const a=this.#j(l),o=""!==a,c=this.#z(t,r),u=o?`${c}: ${a}`:c,d=e.Utils.i18n(n[r]??s?.[r]?.name??""),p=d?`${d}: ${u}`:u,f=[r,t.actorKey??t.id].join(this.delimiter),y={id:t.id,name:u,encodedValue:f,listName:p};return o&&(y.info1={text:a}),y}#U(e,t,i){const n=this.#R(e,i),s=[];t.path&&s.push(t.path);[t.actorKey,t.id].forEach((e=>{e&&(s.push(e),s.push(String(e).replace(/-/g,"_")))}));for(const e of n)for(const t of s){const i=foundry.utils.getProperty(e,t);if(void 0!==i)return i}}#R(e,t){const i=[];e&&"object"==typeof e&&i.push(e);const n=this.actor?.system??{},s="standing"===t?["standing","social","attributes.standing","attributes.social"]:["derived","derivedAttributes","attributes.derived","attributes.derivedAttributes"];for(const e of s){const t=foundry.utils.getProperty(n,e);t&&"object"==typeof t&&!i.includes(t)&&i.push(t)}return n&&"object"==typeof n&&!i.includes(n)&&i.push(n),i}#j(e){if(null==e)return"";if("number"==typeof e||"string"==typeof e)return String(e);const t=this.#N(e.value,e.current,e.rank,e.score,e.points,e.amount,e.total),i=this.#N(e.max,e.maximum,e.cap,e.limit,e.maxValue,e.maximumValue);if(void 0!==t&&void 0!==i)return`${t}/${i}`;if(void 0!==t)return String(t);if(void 0!==e.current&&void 0!==e.max)return`${e.current}/${e.max}`;if(void 0!==e.current)return String(e.current);if(void 0!==e.rank&&void 0!==e.cap)return`${e.rank}/${e.cap}`;if(void 0!==e.rank)return String(e.rank);const n=Object.values(e).filter((e=>"number"==typeof e));return 1===n.length?String(n[0]):n.length>1?n.join("/"):""}#z(t,i){const n=t.translationKey;if(n)return e.Utils.i18n(n);if(t.label)return e.Utils.i18n(t.label);const s="standing"===i?"l5r5e.social":"l5r5e.attributes",r=t.actorKey??t.id;if(r){const t=`${s}.${String(r).replace(/-/g,"_").toLowerCase()}`;return e.Utils.i18n(t)}return t.id}#d(e,t){if(!e||!t)return"";const i=e?.system?.rings??{},n=sanitizeId(t),s=unsanitizeId(t),r=[i?.[t],i?.[n],i?.[s]];for(const e of r){const t=this.#K(e);if(""!==t&&null!=t)return t}if(i&&"object"==typeof i)for(const[e,t]of Object.entries(i)){if(sanitizeId(e)!==n)continue;const i=this.#K(t);if(""!==i&&null!=i)return i}return""}#K(e){if(null==e)return"";if("number"==typeof e||"string"==typeof e)return e;if("object"!=typeof e)return"";for(const t of["value","rank","rating","level","dice","current","score"])if(void 0!==e[t])return e[t];const t=Object.values(e).filter((e=>"number"==typeof e));return 1===t.length?t[0]:t.length>1?t.join("/"):""}#m(t,i,{fallbackPrefix:n}={}){const r=i?.get(t);let l=r?.translationKey,a=r?.label;if(!l&&n){l=`${n}.${String(r?.actorKey??t).replace(/-/g,"_").toLowerCase()}`}const o=s?.[t]?.name;return{id:t,name:l?e.Utils.i18n(l):a?e.Utils.i18n(a):o?e.Utils.i18n(o):this.#P(t),type:"system"}}#_(t){const i=t,n=s?.[i]?.name;return{id:i,name:n?e.Utils.i18n(n):i,type:"system"}}#N(...e){return e.find((e=>null!=e))}#i(e){return new Map(e.map((e=>[e.id,e])))}#P(e){return String(e??"").split(/[-_]/).filter((e=>e.length>0)).map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}#p(e){const t=e??[];return Array.isArray(t)?t.map((e=>{if(!e)return null;const t=sanitizeId(e?.name??"");return[e?.id??e?._id??(t||foundry.utils.randomID()),e]})).filter((e=>Array.isArray(e)&&e[1])):"function"==typeof t?.entries||t instanceof Map?[...t.entries()].filter((([,e])=>!!e)):"object"==typeof t&&null!==t?Object.entries(t).filter((([,e])=>!!e&&"object"==typeof e)):[]}#f(e){const t=e?.system??{},i=["quantity","quantity.value","quantity.current","quantity.amount","quantity.count","qty","qty.value","count","count.value","amount","amount.value","stack","stack.value","stock","stock.value","details.quantity","details.qty","summary.quantity","summary.qty"];for(const e of i){const i=foundry.utils.getProperty(t,e),n=this.#M(i);if(null!==n)return n}return null}#M(e){if(null==e)return null;if("number"==typeof e)return Number.isNaN(e)?null:e;if("boolean"==typeof e)return e?1:0;if("string"==typeof e){const t=e.trim();if(""===t)return null;const i=Number(t);return Number.isNaN(i)?null:i}if("object"==typeof e){const t=["value","current","amount","count","quantity","max","min"];for(const i of t){if(!(i in e))continue;const t=this.#M(e[i]);if(null!==t)return t}}return null}#g(e){const t=e?.system??{},i=[t.equipped,t?.equipped?.value,t?.equipped?.status,t?.equipped?.equipped,t?.equipped?.isEquipped,t?.equipped?.active,t?.readied,t?.readied?.value,t?.ready,t?.ready?.value,t?.worn,t?.worn?.value,t?.wearing,t?.wearing?.value,t?.active,t?.active?.value,t?.state,t?.state?.value,t?.status];for(const e of i){const t=this.#G(e);if(null!==t)return t}return!1}#G(e){if(null==e)return null;if("boolean"==typeof e)return e;if("number"==typeof e)return Number.isNaN(e)?null:0!==e&&(1===e||null);if("string"==typeof e){const t=e.trim().toLowerCase();return t?!!["true","equipped","worn","ready","readied","yes","active","on","enabled"].includes(t)||!["false","unequipped","stowed","stored","no","inactive","off","disabled"].includes(t)&&null:null}if("object"==typeof e){const t=["value","equipped","isEquipped","status","active","enabled","state"];for(const i of t){if(!(i in e))continue;const t=this.#G(e[i]);if(null!==t)return t}}return null}async#h(e,t,i="item"){if(!("string"==typeof t?t:t?.id))return;const n=this.#p(e);if(0===n.length)return;const s=await Promise.all(n.map((async([,e])=>await this.#O(i,e))));this.addActions(s,t)}async#O(t,i){const s=sanitizeId(i.name??"")||foundry.utils.randomID(),r=String(i.id??i.uuid??s);let l=i?.name??i?.label;const a=`${`${e.Utils.i18n(n[t])}: `??""}${l}`;let o="";if(Object.hasOwn(i.system,"readied")){o=`toggle${i.system.readied?" active":""}`}const c=[t,r].join(this.delimiter),u=e.Utils.getImage(i),d=this.#V(i?.system?.activation?.type);let p=this.#B(i);const f=p?.info1,y=p?.info2,g=p?.info3,m=await this.#F(i);return{id:r,name:l,encodedValue:c,cssClass:o,img:u,icon1:d,icon2:null,info1:f,info2:y,info3:g,listName:a,tooltip:await this.#W(m)}}#V(e){}#B(e){return{info1:{text:this.#Q(e)},info2:{text:this.#J(e)},info3:{text:this.#Z(e)}}}#Q(e){const t=e?.system?.quantity??0;return t>1?t:""}#J(e){const t=e?.system?.uses;return t&&(t.value>0||t.max>0)?`${t.value??"0"}${t.max>0?`/${t.max}`:""}`:""}#Z(e){const t=e?.system?.consume?.target,i=e?.system?.consume?.type;if(t===e.id)return"";if("attribute"===i){if(!t)return"";const e=t.substr(0,t.lastIndexOf(".")),i=this.actor.system[e];return i?`${i.value??"0"}${i.max?`/${i.max}`:""}`:""}const n=this.items.get(t);if("charges"===i){const e=n?.system.uses;return e?.value?`${e.value}${e.max?`/${e.max}`:""}`:""}return n?.system?.quantity??""}async#F(e){if("none"===this.tooltipsSetting)return"";const t=e?.name??"";if("nameOnly"===this.tooltipsSetting)return t;const i="string"==typeof e?.system?.description?e?.system?.description:e?.system?.description?.value??"",n=e?.modifiers??null,s=[...e?.system?.chatProperties??[],...e?.system?.equippableItemCardProperties??[],...e?.system?.activatedEffectCardProperties??[]].filter(Boolean),r=e?.type;return{name:t,type:r,description:i,modifiers:n,properties:s,rarity:e?.system?.rarity?.value??e?.system?.rarity??null,traits:this.#X(e?.system?.properties),patterns:this.#Y(e?.system?.patterns),tags:this.#ee(e?.system?.tags),bonuses:this.#te(e?.system?.bonuses),range:"weapon"===r?e?.system?.range?.value??e?.system?.range:null,damage:"weapon"===r?e?.system?.damage?.value??e?.system?.damage:null,deadliness:"weapon"===r?e?.system?.deadliness?.value??e?.system?.deadliness:null,grip1:"weapon"===r?e?.system?.grip_1?.value??e?.system?.grip_1:null,grip2:"weapon"===r?e?.system?.grip_2?.value??e?.system?.grip_2:null,physical:"armor"===r?e?.system?.armor?.physical?.value??e?.system?.armor?.physical:null,supernatural:"armor"===r?e?.system?.armor?.supernatural?.value??e?.system?.armor?.supernatural:null}}#X(t){const i=this.#ie(t);if(!i.length)return null;const n=i.map((t=>{if(!t)return null;const i="object"==typeof t?t:{id:t},n=this.#ne(i?.id??i?.key??i?.slug??i?.name);if(!n)return null;if(!(!1!==(i?.active??i?.enabled??i?.value??!0)))return null;const s=a[n],r=i?.label??i?.name??this.#se(n);if(!s&&!r)return null;if(!s)return r;const l=e.Utils.i18n(s);return l&&l!==s?l:r??s})).filter(Boolean);return n.length?n:null}async#W(t){if("none"===this.tooltipsSetting)return"";if("string"==typeof t)return t;const i=e.Utils.i18n(t.name);if("nameOnly"===this.tooltipsSetting)return i;const n=`<h3>${i}</h3>`,s=t?.descriptionLocalised??await TextEditor.enrichHTML(e.Utils.i18n(t?.description??""),{async:!0}),r=t?.traits?.length?`<div class="tah-properties">${t.traits.map((e=>`<span class="tah-property">${e}</span>`)).join("")}</div>`:"",l=[t?.rarity?[{label:"tokenActionHud.l5r5e.tooltip.rarity",value:t.rarity,class:this.#re(t.rarity)}]:[],"weapon"===t.type?this.#le(t):[],"weapon"===t.type?this.#ae(t):[],"armor"===t.type?this.#oe(t):[],t.patterns??[],t.tags??[],t.bonuses??[]].flat(),a=this.#ce(l);return s||a?`<div>${n}${a?`<div class="tah-tags-wrapper">${a??""}</div>`:""}${s}${r}</div>`:i}#re(e){return e?e<3?"common":e<5?"uncommon":e<7?"rare":e<9?"veryRare":9==e?"legendary":10==e?"artifact":void 0:""}#le(e){return[e.range?{label:"l5r5e.weapons.range",value:e.range}:null,e.damage?{label:"l5r5e.weapons.damage",value:e.damage}:null,e.deadliness?{label:"l5r5e.weapons.deadliness",value:e.deadliness}:null].filter(Boolean)}#ae(e){return[e.grip1&&"N/A"!==e.grip1?{label:"l5r5e.weapons.1hand",value:e.grip1}:null,e.grip2&&"N/A"!==e.grip2?{label:"l5r5e.weapons.2hand",value:e.grip2}:null].filter(Boolean)}#oe(e){return[e?.physical&&e?.physical>0?{label:"l5r5e.armors.physical",value:e?.physical}:null,e?.supernatural&&e?.supernatural>0?{label:"l5r5e.armors.supernatural",value:e?.supernatural}:null].filter(Boolean)}#Y(e){const t=this.#ie(e);if(!t.length)return null;const i=c.pattern??c.default,n=i?.icon??c.default?.icon,s=i?.class??c.default?.class,r=t.map((e=>{if(!e)return null;const t="object"==typeof e?e:{id:e},i=this.#ne(t?.id??t?.key??t?.slug??t?.name);if(!i)return null;if(!(!1!==(t?.active??t?.enabled??t?.value??!0)))return null;const r=o[i],l=t?.label??t?.name??this.#se(i);return r||l?{label:r??l,localized:!r&&Boolean(l),fallback:l,icon:n,class:s}:null})).filter(Boolean);return r.length?r:null}#ee(e){const t=this.#ie(e);if(!t.length)return null;const i=t.map((e=>{if(!e)return null;const t="object"==typeof e?e:{id:e},i=this.#ne(t?.id??t?.key??t?.slug??t?.type??t?.name);if(!i)return null;if(!(!1!==(t?.active??t?.enabled??t?.value??!0)))return null;const n=c[i]??c.default,s=n?.label??(i?`tokenActionHud.l5r5e.tags.${i}`:null),r=t?.label??t?.name??this.#se(i),l=t?.amount??t?.rating??t?.value,a="number"==typeof l||"string"==typeof l?l:void 0;return s||r?{label:s??r,localized:!s&&Boolean(r),fallback:r,value:a,icon:n?.icon??c.default?.icon,class:n?.class??c.default?.class}:null})).filter(Boolean);return i.length?i:null}#te(e){const t=this.#ie(e);if(!t.length)return null;const i=c.bonus??c.default,n=t.map((e=>{if(!e)return null;const t="object"==typeof e?e:{id:e},n=this.#ne(t?.id??t?.key??t?.slug??t?.type??t?.name);if(!n)return null;if(!(!1!==(t?.active??t?.enabled??!0)))return null;const s=u[n]??i,r=s?.label??(n?`tokenActionHud.l5r5e.bonuses.${n}`:null),l=t?.label??t?.name??this.#se(n),a=t?.value??t?.amount??t?.bonus??t?.rating,o="number"==typeof a||"string"==typeof a?a:void 0;return r||l||void 0!==o?{label:r??l,localized:!r&&Boolean(l),fallback:l,value:o,icon:s?.icon??i?.icon,class:s?.class??i?.class}:null})).filter(Boolean);return n.length?n:null}#ce(e){if(!e||0===e.length)return"";const t=e.map((e=>this.#ue(e))).filter(Boolean).join("");return t?`<div class="tah-tags">${t}</div>`:""}#ue(t){if(!t)return"";const i=["tah-tag"];t.class&&i.push(t.class);const n=i.filter(Boolean).join(" "),s=t.icon?`<i class="${t.icon}" aria-hidden="true"></i>`:"";if(t.text)return`<span class="${n}">${s}${s?`<span class="tah-tag-text">${t.text}</span>`:t.text}</span>`;const r=t.label??"";let l="";if(t.localized?l=r:r&&(l=e.Utils.i18n(r),t.fallback&&l===r&&(l=t.fallback)),l||(l=t.fallback??""),!l)return"";const a=void 0!==t.value&&null!==t.value&&""!==t.value?`${l}: ${t.value}`:l;return`<span class="${n}"${t.title?` title="${t.title}"`:""}>${s?`${s}<span class="tah-tag-text">${a}</span>`:a}</span>`}#ie(e){return e?Array.isArray(e)?e.filter((e=>null!=e)):e instanceof Map?Array.from(e.entries()).map((([e,t])=>"object"==typeof t&&null!==t?{id:e,...t}:{id:e,value:t})):e instanceof Set?[...e]:"object"==typeof e?Object.entries(e).map((([e,t])=>"object"==typeof t&&null!==t?{id:e,...t}:{id:e,value:t})):[e]:[]}#ne(e){if(null==e)return"";return("string"==typeof e?e:String(e)).trim().replace(/\s+/g,"_").replace(/[A-Z]/g,(e=>`_${e.toLowerCase()}`)).replace(/[-]+/g,"_").replace(/__+/g,"_").replace(/^_+|_+$/g,"")}#se(e){return e&&"string"==typeof e?e.replace(/[-_]/g," ").replace(/\s+/g," ").trim().replace(/\b\w/g,(e=>e.toUpperCase())):""}}}function getCoreModule(){const e=game.modules.get(t.ID);if(!e)throw new Error("Token Action HUD Core module is not available. Please ensure it is installed and active.");return e}function getCoreApi(){const e=getCoreModule();if(!e.api)throw new Error("Token Action HUD Core API is not available. Ensure you are using Token Action HUD Core 2.x or later.");return e.api}function getCoreApiIfAvailable(){return game.modules.get(t.ID)?.api??null}function resolveCoreApi(e=null){return e?.registerSystem||e?.SystemManager?e:e?.api?.registerSystem?e.api:getCoreApiIfAvailable()}let g=null,m=!1,h=!1;function buildDefaults(e){if(m)return;const t=resolveCoreApi(e);if(!t)return;const i=s,n=getTechniqueTypeEntries();n.forEach((e=>{i[e.id]?i[e.id].name||(i[e.id].name=e.translationKey??e.label??e.id):i[e.id]={id:e.id,name:e.translationKey??e.label??e.id,type:"system"}})),Object.values(i).forEach((e=>{e.name=t.Utils.i18n(e.name),e.listName=`Group: ${t.Utils.i18n(e.listName??e.name)}`}));const r=Object.values(i),l=n.map((e=>({...i[e.id],nestId:`techniques_${String(e.actorKey??e.id).replace(/[^a-zA-Z0-9]+/g,"_")}`})));g={layout:[{nestId:"inventory",id:"inventory",name:t.Utils.i18n("l5r5e.sheets.inventory"),groups:[{...i.weapons,nestId:"inventory_weapons"},{...i.armor,nestId:"inventory_armor"},{...i.equipment,nestId:"inventory_items"}]},{nestId:"attributes",id:"attributes",name:t.Utils.i18n("l5r5e.attributes.title"),groups:[{...i.rings,nestId:"attributes_rings"},{...i.derived,nestId:"attributes_derived"},{...i.standing,nestId:"attributes_standing"}]},{nestId:"skills",id:"skills",name:t.Utils.i18n("l5r5e.skills.title"),groups:[{...i.artisan,nestId:"skills_artisan"},{...i.martial,nestId:"skills_martial"},{...i.scholar,nestId:"skills_scholar"},{...i.social,nestId:"skills_social"},{...i.trade,nestId:"skills_trade"}]},{nestId:"techniques",id:"techniques",name:t.Utils.i18n("l5r5e.techniques.title"),groups:l},{nestId:"utility",id:"utility",name:t.Utils.i18n("tokenActionHud.utility"),groups:[{...i.combat,nestId:"utility_combat"},{...i.token,nestId:"utility_token"},{...i.rests,nestId:"utility_rests"},{...i.utility,nestId:"utility_utility"}]}],groups:r},m=!0,h=!1}function prepareDefaults(){if(m)return;const e=resolveCoreApi();e?buildDefaults(e):h||(h=!0,Hooks.once("tokenActionHudCoreApiReady",buildDefaults))}function createRollHandlerClass(e){return class RollHandler extends e.RollHandler{async handleActionClick(e,t){const[i,n]=t.split("|"),s="function"==typeof this.isRenderItem&&this.isRenderItem(e),r=s||"contextmenu"===e?.type||2===e?.button||2===e?.data?.button||!0===e?.data?.isRightClick;if(["item","weapons","technique","armor"].includes(i)&&s)return this.doRenderItem(this.actor,n);if(["ring"].includes(i)&&r&&"ring"===i)return void await this.#de(e,this.actor,n);const l=["character"];if(this.actor)return void await this.#pe(e,this.actor,this.token,i,n);const a=canvas.tokens.controlled.filter((e=>l.includes(e.actor?.type)));for(const t of a){const s=t.actor;await this.#pe(e,s,t,i,n)}}async handleActionHover(e,t){}async handleGroupClick(e,t){}async#pe(e,t,i,n,s){switch(n){case"weapons":await this.#fe(e,t,i,s);break;case"ring":await this.#ye(e,t,i,s);break;case"skill":await this.#ge(e,t,i,s);break;case"technique":await this.#me(e,t,i,s);break;case"armor":case"equipment":await this.#he(e,t,s,i);break;case"utility":this.#ke(i,s)}}async#he(e,t,i,n){const s=t.items.get(i);if(!s)return;const r=game.l5r5e??{},l=r.HelpersL5r5e??{},a=r.Chat??r.chat??{},o=r.applications?.chat??r.apps?.chat??{},c=r.ChatMessage??{},u="function"==typeof ChatMessage?.getSpeaker?ChatMessage.getSpeaker({actor:t,token:n}):{actor:t?.id,token:n?.id},d={actor:t,token:n,speaker:u,item:s,source:"token-action-hud"},p=[{fn:l.sendItemToChat,context:l},{fn:l.sendToChat,context:l},{fn:l.displayItem,context:l},{fn:a.sendItemToChat,context:a},{fn:a.displayItem,context:a},{fn:a.createItemMessage,context:a},{fn:a.showItemCard,context:a},{fn:a.renderItemCard,context:a},{fn:o.sendItemToChat,context:o},{fn:o.displayItem,context:o},{fn:o.renderItemCard,context:o},{fn:c.createItemMessage,context:c},{fn:c.sendItemToChat,context:c},{fn:r.ChatV2?.createItemMessage,context:r.ChatV2},{fn:s?.sendToChat,context:s},{fn:s?.displayCard,context:s},{fn:s?.showItemCard,context:s},{fn:s?.toMessage,context:s}].filter((e=>"function"==typeof e?.fn));for(const e of p)try{const{fn:i,context:r}=e,l="number"==typeof i.length?i.length:1;let a;if(r===s&&i===s?.toMessage){const e={speaker:u};a=await i.call(r,e,{create:!0})}else a=r===s?l<=0?await i.call(r):1===l?await i.call(r,d):await i.call(r,d,{create:!0}):l<=1?await i.call(r,s):2===l?await i.call(r,s,d):await i.call(r,s,d,{actor:t,token:n});if(!1!==a)return}catch(e){continue}"function"==typeof ChatMessage?.create?await ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:t}),content:game.i18n.format("tokenActionHud.l5r5e.itemChatFallback",{item:s.name})}):ui.notifications?.warn(game.i18n.format("tokenActionHud.l5r5e.itemChatFallback",{item:s.name}))}async#de(e,t,i){const n=["character","npc"],s=Object.keys(CONFIG.l5r5e?.conflict?.stances??{});if(s.length>0&&!s.includes(i))return;const r=t?[t]:canvas.tokens.controlled.map((e=>e.actor)).filter((e=>e&&n.includes(e.type)));if(r&&0!==r.length)for(const e of r)if(n.includes(e.type)&&e.system?.stance!==i&&e.canUserModify?.(game.user,"update"))try{await e.update({"system.stance":i})}catch(e){console.error(e)}}async#fe(e,t,i,n){const s=t.items.get(n);if(!s)return;const r=this.#be(s?.system?.skill),l=this.#Ae(s?.system?.ring),a={item:s,itemId:s.id,sourceId:s.id,type:s.type,itemType:s.type,title:s.name,difficulty:s?.system?.tn??s?.system?.difficulty??null,context:"token-action-hud"};null!==a.difficulty&&void 0!==a.difficulty&&(a.tn=a.tn??a.difficulty,a.targetNumber=a.targetNumber??a.difficulty),r.length>0&&(a.skill=r[0],a.skillId=r[0],a.skills=r,a.skillsList=r),l&&(a.ring=l,a.ringId=l),await this.#ve(t,a,i)}async#ye(e,t,i,n){const s={ring:n,ringId:n,context:"token-action-hud"};await this.#ve(t,s,i)}async#ge(e,t,i,n){const s={skill:n,skillId:n,context:"token-action-hud"};await this.#ve(t,s,i)}async#me(e,t,i,n){const s=t.items.get(n);if(!s||"technique"!==s.type)return;const r=this.#be(s?.system?.skill),l=this.#Ae(s?.system?.ring),a=s?.system?.difficulty??s?.system?.tn??null,o={item:s,itemId:s.id,sourceId:s.id,type:s.type,itemType:s.type,title:s.name,difficulty:a,context:"token-action-hud"};null!=a&&(o.tn=o.tn??a,o.targetNumber=o.targetNumber??a),r.length>0&&(o.skill=r[0],o.skillId=r[0],o.skills=r,o.skillsList=r),l&&(o.ring=l,o.ringId=l),await this.#ve(t,o,i)}async#ve(e,t={},i){const n=this.#Ie(e,t,i),s=this.#Se();if(s){const t=await this.#qe(s,e,n);if(null!=t&&!1!==t)return t}const r=await this.#Ce(e,n);if(null!=r&&!1!==r)return r;const l=game.i18n?.localize?.("tokenActionHud.l5r5e.dicePickerError"),a=game.i18n?.localize?.("tokenActionHud.notifications.dicePickerError"),o=l&&"tokenActionHud.l5r5e.dicePickerError"!==l?l:a&&"tokenActionHud.notifications.dicePickerError"!==a?a:"Token Action HUD L5R5e: Unable to open Dice Picker Dialog";return ui.notifications?.warn?.(o),null}#Ie(e,t={},i){const n={...t};e&&!n.actor&&(n.actor=e),e?.id&&!n.actorId&&(n.actorId=e.id),e?.uuid&&!n.actorUuid&&(n.actorUuid=e.uuid),e?.type&&!n.actorType&&(n.actorType=e.type),i&&!n.token&&(n.token=i);const s=i?.document??i;s?.id&&!n.tokenId&&(n.tokenId=s.id),s?.uuid&&!n.tokenUuid&&(n.tokenUuid=s.uuid),s?.scene?.id&&!n.sceneId&&(n.sceneId=s.scene.id),s?.scene?.uuid&&!n.sceneUuid&&(n.sceneUuid=s.scene.uuid),n.item&&!n.itemId&&(n.itemId=n.item.id),n.item&&!n.sourceId&&(n.sourceId=n.sourceId??n.item.id),n.item&&!n.itemType&&(n.itemType=n.item.type),n.item?.uuid&&!n.itemUuid&&(n.itemUuid=n.item.uuid),n.item&&!n.title&&(n.title=n.item.name);const r=this.#we([n.skill,n.skillId,...Array.isArray(n.skills)?n.skills:[],...Array.isArray(n.skillsList)?n.skillsList:[]]);r.length>0&&(n.skill=r[0],n.skillId=r[0],n.skills=r,n.skillsList=r);const l=this.#Ae(n.ring??n.ringId??n.ringKey);l&&(n.ring=l,n.ringId=l,n.ringKey=l),n.context||(n.context="token-action-hud"),null!==n.difficulty&&void 0!==n.difficulty&&(n.tn=n.tn??n.difficulty,n.targetNumber=n.targetNumber??n.difficulty),null!==n.tn&&void 0!==n.tn&&(n.difficulty=n.difficulty??n.tn,n.targetNumber=n.targetNumber??n.tn),null!==n.targetNumber&&void 0!==n.targetNumber&&(n.difficulty=n.difficulty??n.targetNumber,n.tn=n.tn??n.targetNumber);const a=r[0],o=n.targetNumber??n.tn??n.difficulty??null,c={};return a&&(c.skill=a,c.skillId=a,c.skillKey=a),l&&(c.ring=l,c.ringId=l,c.ringKey=l),null!=o&&(c.tn=o,c.difficulty=o,c.targetNumber=o),n.action=n.action?{...c,...n.action}:{...c},n.check=n.check?{...c,...n.check}:{...c},n.dicePool=n.dicePool?{...c,...n.dicePool}:{...c},n.pool=n.pool?{...c,...n.pool}:{...c},n}#Se(){const e=game?.l5r5e??{},t=[e,e?.Dice,e?.dice,e?.DiceRoller,e?.apps,e?.apps?.dice,e?.apps?.Dice,e?.apps?.dialogs,e?.applications,e?.applications?.dice,e?.applications?.Dice,e?.applications?.dialogs,e?.ui,e?.ui?.dice,e?.modules,CONFIG?.l5r5e,CONFIG?.l5r5e?.apps,CONFIG?.l5r5e?.dice],i=["DicePickerDialog","DicePoolDialog","DiceDialog","DiceRollDialog","DiceCheckDialog","CheckDialog","RollDialog","SkillCheckDialog","SkillRollDialog"];for(const e of t)if(e)for(const t of i){const i=e?.[t],n=this.#xe(i);if(n)return n}return null}#xe(e,t=0){if(!e||t>3)return null;if("function"==typeof e)return e;if("object"==typeof e){if(["show","open","create","launch","render"].some((t=>"function"==typeof e?.[t])))return e;const i=["Dialog","dialog","default","DicePickerDialog","DicePoolDialog","DiceDialog"];for(const n of i){const i=e?.[n],s=this.#xe(i,t+1);if(s)return s}}return null}async#qe(e,t,i){if(!e)return null;const n=[["show",[[i],[t,i],[i,t]]],["open",[[i],[t,i],[i,t]]],["create",[[i],[t,i],[i,t]]],["launch",[[i],[t,i],[i,t]]],["render",[[i]]]];for(const[t,i]of n){const n=e?.[t];if("function"==typeof n)for(const t of i)try{const i=await n.apply(e,t);if(void 0!==i)return i}catch(e){continue}}const s=this.#He(t,i),r="function"==typeof e&&"number"==typeof e.length?e.length:null,l=null!==r&&r>=0?s.filter((e=>e.length===r)):s;if("function"==typeof e){for(const t of l)try{const i=await e(...t);if(void 0!==i)return i}catch(e){continue}for(const t of l)try{const n=new e(...t);return"function"==typeof n?.render?n.render(!0):"function"==typeof n?.open&&await n.open(i),n}catch(e){continue}}if("object"==typeof e){for(const t of["show","open","create","launch"]){const i=e?.[t];if("function"==typeof i)for(const t of s)try{const n=await i.apply(e,t);if(void 0!==n)return n}catch(e){continue}}if("function"==typeof e?.render)try{const t=await e.render(i);if(void 0!==t)return t}catch(e){}}return null}async#Ce(e,t){const i=game?.l5r5e??{},n=[{fn:e?.rollSkill,context:e},{fn:e?.rollCheck,context:e},{fn:e?.rollDicePool,context:e},{fn:e?.rollAction,context:e},{fn:e?.roll,context:e},{fn:i?.dice?.rollSkill,context:i?.dice},{fn:i?.dice?.rollCheck,context:i?.dice},{fn:i?.dice?.rollDicePool,context:i?.dice},{fn:i?.Dice?.roll,context:i?.Dice},{fn:i?.Roller?.roll,context:i?.Roller},{fn:i?.DiceRoller?.roll,context:i?.DiceRoller},{fn:i?.rollSkill,context:i},{fn:i?.rollCheck,context:i},{fn:i?.rollDicePool,context:i}].filter((e=>"function"==typeof e.fn)),s=this.#He(e,t);for(const{fn:e,context:t}of n)for(const i of s)try{const n=await e.apply(t,i);if(!1!==n)return n??!0}catch(e){continue}return null}#He(e,t){const i=[];i.push([]),i.push([t]),i.push([e,t]),i.push([t,e]),i.push([t,{actor:e}]),i.push([{actor:e,options:t}]),t?.context&&(i.push([e,t,t.context]),i.push([t,e,t.context]),i.push([{actor:e,context:t.context,options:t}]));const n=t?.token;n&&(i.push([e,t,n]),i.push([t,n,e]),i.push([{actor:e,token:n,options:t}]));const s=t?.skill??t?.skillId,r=t?.ring??t?.ringId;s&&(i.push([s]),i.push([s,t]),i.push([s,t,e]),i.push([{skill:s,options:t}]),r&&(i.push([s,r]),i.push([s,r,t]),i.push([{skill:s,ring:r,actor:e,options:t}]))),r&&!s&&(i.push([r]),i.push([r,t]));const l=new Set,a=[];for(const s of i){const i=s.filter((e=>void 0!==e)),r=JSON.stringify(i,((i,s)=>s===e?"__ACTOR__":s===t?"__OPTIONS__":s===n?"__TOKEN__":"object"==typeof s&&null!==s?"__OBJECT__":s));l.has(r)||(l.add(r),a.push(i))}return a}#Ae(e){if(e)if(e instanceof Set)for(const t of e){const e=this.#Ae(t);if(e)return e}else if(e instanceof Map)for(const t of e.values()){const e=this.#Ae(t);if(e)return e}else{if("string"==typeof e)return e;if("number"==typeof e)return String(e);if(Array.isArray(e))for(const t of e){const e=this.#Ae(t);if(e)return e}else if("object"==typeof e){const t=["ring","id","key","value","default","defaultRing"];for(const i of t)if(e[i]){const t=this.#Ae(e[i]);if(t)return t}}}}#be(e){if(!e)return[];if(e instanceof Set)return this.#we([...e].flatMap((e=>this.#be(e))));if(e instanceof Map)return this.#we([...e.values()].flatMap((e=>this.#be(e))));if(Array.isArray(e))return this.#we(e.flatMap((e=>this.#be(e))));if("string"==typeof e)return[e];if("number"==typeof e)return[String(e)];if("object"==typeof e){const t=["id","ids","skill","skills","skillId","skillIds","skill_ids","skillList","skillsList","value","values","default","primary","entry","entries","list","items"];for(const i of t)if(e[i])return this.#be(e[i]);return this.#we(Object.values(e).flatMap((e=>this.#be(e))))}return[]}#we(e){return[...new Set(e.map((e=>null==e?"":String(e))).filter((e=>e)))]}async#ke(e,t){if("endTurn"===t)game.combat?.current?.tokenId===e.id&&await(game.combat?.nextTurn())}}}function register(t){game.settings.register(e.ID,"displayUnequipped",{name:game.i18n.localize("tokenActionHud.l5r5e.settings.displayUnequipped.name"),hint:game.i18n.localize("tokenActionHud.l5r5e.settings.displayUnequipped.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}})}function createSystemManagerClass(e){const t=createActionHandlerClass(e),i=createRollHandlerClass(e);return class SystemManager extends e.SystemManager{getActionHandler(){return new t}getAvailableRollHandlers(){return{core:"Core Template"}}getRollHandler(e){let t;return t=new i,t}async registerDefaults(){return g}registerSettings(e){register(e)}}}Hooks.once("init",prepareDefaults),Hooks.once("ready",prepareDefaults);let k=!1,b=!1;function registerWithCore(t){if(k)return;const i=resolveCoreApi(t);if(i)if("function"==typeof i.registerSystem)try{const t=createSystemManagerClass(i);i.registerSystem({moduleId:e.ID,requiredCoreModuleVersion:"2.0.12",SystemManager:t}),k=!0,b=!1}catch(e){console.error("Failed to register Token Action HUD L5R5E system with Token Action HUD Core.",e)}else console.error("Token Action HUD Core API does not provide registerSystem. Please update Token Action HUD Core to version 2.x.");else console.error("Token Action HUD Core API is not available. Ensure Token Action HUD Core 2.x is installed and active.")}function prepareRegistration(){if(k)return;const e=resolveCoreApi();e?registerWithCore(e):b||(b=!0,Hooks.once("tokenActionHudCoreApiReady",registerWithCore))}Hooks.once("init",(()=>{prepareRegistration()})),Hooks.once("ready",(()=>{prepareRegistration()}));let A=null,v=!1,I=!1;function initialiseUtils(t){if(v)return;const i=resolveCoreApi(t);if(!i)return;const n=i.Logger;A=class Utils{static getSetting(t,i=null){let s=i??null;try{s=game.settings.get(e.ID,t)}catch{n?.debug?.(`Setting '${t}' not found`)}return s}static async setSetting(t,i){try{const s=await game.settings.set(e.ID,t,i);return n?.debug?.(`Setting '${t}' set to '${s}'`),s}catch{return n?.debug?.(`Setting '${t}' not found`),i}}},v=!0,I=!1}function prepareUtils(){if(v)return;const e=resolveCoreApi();e?initialiseUtils(e):I||(I=!0,Hooks.once("tokenActionHudCoreApiReady",initialiseUtils))}Hooks.once("init",prepareUtils),Hooks.once("ready",prepareUtils);export{n as ACTION_TYPE,t as CORE_MODULE,g as DEFAULTS,s as GROUP,u as ITEM_BONUS,o as ITEM_PATTERN,a as ITEM_QUALITIES,c as ITEM_TAGS,r as ITEM_TYPE,e as MODULE,i as REQUIRED_CORE_MODULE_VERSION,l as SKILL_TYPE,A as Utils,createActionHandlerClass,createRollHandlerClass,createSystemManagerClass,getActorSection,getAttributeEntries,getCoreApi,getCoreApiIfAvailable,getCoreModule,getInventoryGroupEntries,getRingEntries,getTechniqueTypeEntries,register,resolveCoreApi,sanitizeId,unsanitizeId};
